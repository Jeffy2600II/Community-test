<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>จัดการบัญชี — Community</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* Local additions for accounts page layout and notification controls.
       Kept minimal and scoped to this page. Buttons can wrap onto next line
       when space is constrained (flex-wrap). */
    .accounts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }
    .accounts-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .account-row {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 10px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid rgba(15,23,42,0.04);
      cursor: pointer;
      transition: background 160ms ease, transform 120ms ease;
    }
    .account-row:focus { outline: 2px solid rgba(47,128,237,0.12); outline-offset: 2px; }
    .account-row:hover { background: #fbfdff; transform: translateY(-1px); }
    .account-row .profile-pic { border-radius: 8px; object-fit: cover; width:48px; height:48px; }
    .account-info { display:flex; flex-direction:column; gap:4px; min-width:0; }
    .account-active {
      background: linear-gradient(90deg, rgba(47,128,237,0.12), rgba(23,194,161,0.06));
      padding: 4px 8px;
      border-radius: 999px;
      color: var(--accent);
      font-weight:700;
      font-size: 0.85rem;
    }
    .account-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .profile-pic-small { width:40px; height:40px; border-radius:8px; object-fit:cover; }

    /* Notification panel */
    .notif-card { display:flex; flex-direction:column; gap:8px; }
    .notif-controls {
      display:flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap; /* allow buttons to wrap and stack when narrow */
    }
    .notif-controls .small { margin-right:auto; color:var(--muted); }
    .notif-list {
      max-height: 320px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px 0;
    }
    .notif-item {
      padding: 10px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid rgba(15,23,42,0.04);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .notif-item.unread { background: #fffef6; }
    .notif-item .meta { display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .notif-empty { padding: 12px; color:var(--muted); }

    /* Small screens: ensure controls stack nicely */
    @media (max-width: 600px) {
      .accounts-header { flex-direction: column; align-items: flex-start; }
      .notif-controls { justify-content: flex-start; }
      .account-row { padding: 12px; }
    }
  </style>
</head>
<body>
  <div id="headerSlot"></div>

  <main>
    <div class="container" style="max-width:900px;margin-top:24px;">
      <div class="section-title"><span>จัดการบัญชี</span></div>

      <div class="card accounts-header" role="group" aria-label="บัญชีที่บันทึกไว้">
        <div>
          <h2 style="margin:0;">บัญชีที่บันทึกไว้</h2>
          <div class="small">คุณสามารถเพิ่ม, สลับ หรือออกจากบัญชีได้ที่นี่</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <a href="/login?add=1" class="btn btn-secondary">เพิ่มบัญชี</a>
        </div>
      </div>

      <div id="accountsList" class="card accounts-list" aria-live="polite">
        <div class="small">กำลังโหลด...</div>
      </div>

      <div id="activeAccountPanel" class="card hidden" aria-hidden="true">
        <h3>บัญชีที่ใช้งานอยู่</h3>
        <div id="activeAccountInfo" class="mt-16"></div>
      </div>

      <div class="card notif-card" id="notificationsCard" aria-live="polite">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div>
            <h3 style="margin:0;">การแจ้งเตือน</h3>
            <div class="small">จัดการการแจ้งเตือนของบัญชีที่เลือก</div>
          </div>
          <div class="notif-controls" role="toolbar" aria-label="Notification actions">
            <div class="small" id="notifSummary">กำลังโหลด…</div>
            <!-- use shared button classes from global CSS; allow wrapping -->
            <button id="btnRefreshNotif" class="btn btn-ghost" type="button" title="รีเฟรชการแจ้งเตือน">รีเฟรช</button>
            <button id="btnMarkAllRead" class="btn btn-primary" type="button" title="ทำเครื่องหมายว่าอ่านทั้งหมด">ทำเครื่องหมายว่าอ่านทั้งหมด</button>
          </div>
        </div>

        <div id="notifList" class="notif-list mt-16">
          <div class="notif-empty">กำลังโหลดการแจ้งเตือน...</div>
        </div>
      </div>

    </div>
  </main>

  <div id="footerSlot"></div>

  <script src="/js/main.js"></script>
  <script>
    // Accounts & Notifications page script
    (function () {
      const accountsListEl = document.getElementById('accountsList');
      const activePanel = document.getElementById('activeAccountPanel');
      const activeAccountInfoEl = document.getElementById('activeAccountInfo');
      const notifListEl = document.getElementById('notifList');
      const notifSummaryEl = document.getElementById('notifSummary');
      const btnRefresh = document.getElementById('btnRefreshNotif');
      const btnMarkAll = document.getElementById('btnMarkAllRead');

      let accountsData = [];
      let activeUsername = null;
      let notifications = [];

      async function apiGet(path) {
        try {
          const r = await fetch(path);
          return await r.json();
        } catch (e) {
          console.error('apiGet error', path, e);
          return null;
        }
      }

      async function apiPost(path, body = {}) {
        try {
          const r = await fetch(path, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          return await r.json();
        } catch (e) {
          console.error('apiPost error', path, e);
          return null;
        }
      }

      function elFromHTML(html) {
        const div = document.createElement('div');
        div.innerHTML = html.trim();
        return div.firstChild;
      }

      async function loadAccounts() {
        accountsListEl.innerHTML = '<div class="small">กำลังโหลด...</div>';
        const data = await apiGet('/api/accounts');
        if (!data || !data.success) {
          accountsListEl.innerHTML = '<div class="small">ไม่สามารถโหลดรายการบัญชีได้</div>';
          return;
        }
        accountsData = data.accounts || [];
        activeUsername = data.active || null;
        renderAccounts();
        renderActivePanel();
        // load notifications for active account
        await loadNotifications();
      }

      function renderAccounts() {
        accountsListEl.innerHTML = '';
        if (!accountsData || accountsData.length === 0) {
          accountsListEl.innerHTML = '<div class="small">ยังไม่มีบัญชีบันทึกไว้</div>';
          return;
        }
        for (const acc of accountsData) {
          const row = document.createElement('div');
          row.className = 'account-row';
          row.tabIndex = 0;
          row.setAttribute('role', 'button');

          // Build contents using existing classes; sign-out/remove uses shared btn classes
          row.innerHTML = `
            <img src="${acc.profilePic || '/img/default_profile.png'}" alt="${acc.username}" class="profile-pic">
            <div class="account-info">
              <div style="display:flex;gap:8px;align-items:center;">
                <div style="font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(acc.displayName || acc.username)}</div>
                ${activeUsername === acc.username ? '<div class="account-active">Active</div>' : ''}
              </div>
              <div class="small" style="color:var(--muted)">${escapeHtml(acc.username)}</div>
            </div>
            <div class="account-actions">
              <button class="btn btn-ghost" data-username="${escapeHtml(acc.username)}" data-action="remove">${activeUsername === acc.username ? 'ออก (Logout)' : 'ออก'}</button>
            </div>
          `;

          // clicking row (except the remove button) switches account if not active
          row.addEventListener('click', async (e) => {
            if (e.target && (e.target.tagName === 'BUTTON' || e.target.closest('button'))) return;
            if (activeUsername === acc.username) return;
            if (!confirm(`สลับไปใช้บัญชี ${acc.username} ?`)) return;
            try {
              const r = await apiPost('/api/accounts/switch', { username: acc.username });
              if (r && r.success) {
                window.dispatchEvent(new Event('accountsChanged'));
                await loadAccounts();
              } else {
                alert(r && r.msg ? r.msg : 'ไม่สามารถสลับบัญชีได้');
              }
            } catch (err) {
              console.error(err);
              alert('เกิดข้อผิดพลาดขณะสลับบัญชี');
            }
          });

          // keyboard support
          row.addEventListener('keydown', (e) => {
            if ((e.key === 'Enter' || e.key === ' ') ) {
              e.preventDefault();
              row.click();
            }
          });

          // remove / sign out button
          const removeBtn = row.querySelector('button[data-action="remove"]');
          removeBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            const un = removeBtn.getAttribute('data-username');
            if (!confirm(`${activeUsername === un ? 'ออกจากระบบและลบจากรายการ?' : 'ออกจากบัญชีนี้?'} `)) return;
            try {
              if (activeUsername === un) {
                // logout active
                await apiPost('/api/logout', {});
              } else {
                await apiPost('/api/accounts/remove', { username: un });
              }
              window.dispatchEvent(new Event('accountsChanged'));
              await loadAccounts();
            } catch (err) {
              console.error(err);
              alert('เกิดข้อผิดพลาดขณะออกจากระบบ');
            }
          });

          accountsListEl.appendChild(row);
        }
      }

      function renderActivePanel() {
        if (!activeUsername) {
          activePanel.classList.add('hidden');
          activePanel.setAttribute('aria-hidden', 'true');
          return;
        }
        const activeAcc = accountsData.find(a => a.username === activeUsername) || accountsData[0];
        if (!activeAcc) {
          activePanel.classList.add('hidden');
          activePanel.setAttribute('aria-hidden', 'true');
          return;
        }
        activePanel.classList.remove('hidden');
        activePanel.setAttribute('aria-hidden', 'false');
        activeAccountInfoEl.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;">
            <img src="${activeAcc.profilePic || '/img/default_profile.png'}" class="profile-pic-small" alt="${activeAcc.username}">
            <div>
              <div style="font-weight:700">${escapeHtml(activeAcc.displayName || activeAcc.username)}</div>
              <div class="small" style="color:var(--muted)">${escapeHtml(activeAcc.username)}</div>
            </div>
          </div>
        `;
      }

      /* ---------------- Notifications ---------------- */
      async function loadNotifications() {
        notifListEl.innerHTML = '<div class="notif-empty">กำลังโหลดการแจ้งเตือน...</div>';
        notifSummaryEl.textContent = 'กำลังโหลด…';
        const data = await apiGet('/api/notifications');
        if (!data || !data.success) {
          notifListEl.innerHTML = '<div class="notif-empty">ไม่สามารถโหลดการแจ้งเตือนได้</div>';
          notifSummaryEl.textContent = 'ไม่สามารถโหลด';
          return;
        }
        notifications = data.notifications || [];
        const unread = data.unread || notifications.filter(n => !n.read).length;
        notifSummaryEl.textContent = `${unread} รายการยังไม่อ่าน`;
        renderNotifications();
      }

      function renderNotifications() {
        notifListEl.innerHTML = '';
        if (!notifications || notifications.length === 0) {
          notifListEl.innerHTML = '<div class="notif-empty">ยังไม่มีการแจ้งเตือน</div>';
          return;
        }
        for (const n of notifications.slice(0, 200)) {
          const it = document.createElement('div');
          it.className = 'notif-item' + (n.read ? '' : ' unread');
          const title = document.createElement('div');
          title.className = 'meta';
          const typ = document.createElement('div');
          typ.style.fontWeight = '700';
          typ.textContent = n.type || 'การแจ้งเตือน';
          const time = document.createElement('div');
          time.className = 'small';
          time.textContent = new Date(n.createdAt).toLocaleString();
          title.appendChild(typ);
          title.appendChild(time);

          const msg = document.createElement('div');
          msg.className = 'small';
          msg.textContent = n.message || '';

          const controls = document.createElement('div');
          controls.style.display = 'flex';
          controls.style.gap = '8px';
          controls.style.marginTop = '6px';
          const btnMark = document.createElement('button');
          btnMark.className = 'btn btn-ghost';
          btnMark.textContent = n.read ? 'ทำเครื่องหมายว่าไม่อ่าน' : 'ทำเครื่องหมายว่าอ่าน';
          btnMark.addEventListener('click', async (ev) => {
            ev.preventDefault(); ev.stopPropagation();
            try {
              await apiPost('/api/notifications/mark-read', { ids: n.read ? [] : [n.id] });
            } catch (e) { /* ignore */ }
            await loadNotifications();
            window.dispatchEvent(new Event('accountsChanged'));
          });

          const btnGoto = document.createElement('a');
          btnGoto.className = 'btn btn-primary';
          btnGoto.textContent = 'ไปที่';
          const dest = computeNotificationUrl(n);
          if (dest) {
            btnGoto.href = dest;
            btnGoto.target = '_self';
          } else {
            btnGoto.href = '#';
            btnGoto.addEventListener('click', (e) => e.preventDefault());
            btnGoto.classList.remove('btn-primary');
            btnGoto.classList.add('btn-ghost');
          }

          controls.appendChild(btnMark);
          controls.appendChild(btnGoto);

          it.appendChild(title);
          it.appendChild(msg);
          it.appendChild(controls);

          notifListEl.appendChild(it);
        }
      }

      // computeNotificationUrl: same logic as used in global nav; best-effort
      function computeNotificationUrl(n) {
        if (!n || !n.meta) return null;
        const m = n.meta;
        if (m.url) return m.url;
        if (m.postId) return `/post/${encodeURIComponent(m.postId)}`;
        if (m.commentId && m.postId) return `/post/${encodeURIComponent(m.postId)}#comment-${encodeURIComponent(m.commentId)}`;
        if (m.actorUsername) return `/user/${encodeURIComponent(m.actorUsername)}`;
        if (m.username) return `/user/${encodeURIComponent(m.username)}`;
        if (m.item && m.item.type === 'post' && m.item.id) return `/post/${encodeURIComponent(m.item.id)}`;
        return null;
      }

      // Refresh & Mark All handlers
      btnRefresh.addEventListener('click', async () => {
        btnRefresh.disabled = true;
        const orig = btnRefresh.textContent;
        btnRefresh.textContent = 'กำลังรีเฟรช…';
        await loadNotifications();
        btnRefresh.disabled = false;
        btnRefresh.textContent = orig || 'รีเฟรช';
      });

      btnMarkAll.addEventListener('click', async () => {
        if (!confirm('ทำเครื่องหมายว่าอ่านทั้งหมด?')) return;
        btnMarkAll.disabled = true;
        const orig = btnMarkAll.textContent;
        btnMarkAll.textContent = 'กำลังบันทึก…';
        try {
          await apiPost('/api/notifications/mark-read', {}); // empty => mark all
        } catch (e) { /* ignore */ }
        await loadNotifications();
        btnMarkAll.disabled = false;
        btnMarkAll.textContent = orig || 'ทำเครื่องหมายว่าอ่านทั้งหมด';
        window.dispatchEvent(new Event('accountsChanged'));
      });

      // helper: escape HTML in outputs
      function escapeHtml(s) {
        if (!s && s !== 0) return '';
        return String(s).replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      }

      // initial load
      window.addEventListener('load', loadAccounts);
      // re-render when accounts change elsewhere in the app
      window.addEventListener('accountsChanged', loadAccounts);

    })();
  </script>
</body>
</html>