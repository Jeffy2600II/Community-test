<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>สร้างโพสต์ใหม่</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      /* small local styles for preview + gallery */
      .preview-wrap { margin-top: 18px; }
      .image-gallery { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
      .image-thumb { position:relative; width:120px; height:90px; border-radius:8px; overflow:hidden; background:#f6f7fb; display:flex;align-items:center;justify-content:center; }
      .image-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
      .image-thumb button.remove { position:absolute; top:6px; right:6px; background:rgba(0,0,0,0.6); color:#fff; border:none; width:26px; height:26px; border-radius:6px; cursor:pointer; }
      .preview-post { margin-top:12px; }
      textarea[name="content"] { min-height:140px; width:100%; padding:10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); font-size:1rem; }
      .small-note { color:var(--muted); font-size:0.92rem; margin-top:8px; }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container" style="max-width:800px;margin-top:24px;">
      <div class="card">
        <div class="section-title"><span>สร้างโพสต์ใหม่</span></div>

        <form id="postForm" enctype="multipart/form-data">
            <label class="small">เนื้อหา</label>
            <textarea name="content" id="contentInput" placeholder="เขียนสิ่งที่คุณต้องการแบ่งปันที่นี่..." required></textarea>

            <div class="input-file mt-16">
              <label class="btn btn-ghost" id="chooseFilesBtn">
                แนบรูปหลายรูป (เลือกหลายไฟล์ได้)
                <input id="fileInput" type="file" name="postImage" multiple style="display:none">
              </label>
              <span class="small-note">สามารถลากเลือกหรือกดปุ่มเพื่อเลือกหลายรูปภาพได้</span>
            </div>

            <div id="selectedImages" class="image-gallery" aria-live="polite" aria-label="รูปที่เลือก"></div>

            <div class="text-right mt-16">
              <button type="submit" class="btn btn-primary">โพสต์</button>
            </div>
            <p id="msg" class="small" style="margin-top:8px"></p>
        </form>

        <div class="preview-wrap">
          <div class="section-title"><span>ตัวอย่างโพสต์</span></div>
          <div id="previewPost" class="preview-post"></div>
        </div>

      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
(function(){
  // utility
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function formatNow(){ return new Date().toLocaleString(); }
  function genId() { return 'f_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*10000).toString(36); }

  const contentInput = document.getElementById('contentInput');
  const fileInput = document.getElementById('fileInput');
  const selectedImages = document.getElementById('selectedImages');
  const previewPost = document.getElementById('previewPost');
  const msg = document.getElementById('msg');
  const postForm = document.getElementById('postForm');
  const chooseFilesBtn = document.getElementById('chooseFilesBtn');

  // state: store objects so removal targets a specific id (not index)
  let files = []; // [{id, file, url}]

  // helpers
  function makePreviewArticle(username, avatarUrl, contentHtml, images, createdAt) {
    const art = document.createElement('article');
    art.className = 'post';
    art.setAttribute('data-preview','1');

    // header
    const header = document.createElement('div'); header.className='post-header';
    const avatarLink = document.createElement('a'); avatarLink.className='post-avatar'; avatarLink.href='#';
    const img = document.createElement('img'); img.className='avatar-img'; img.alt = username || '';
    img.src = avatarUrl || '/img/default_profile.png';
    avatarLink.appendChild(img);
    header.appendChild(avatarLink);

    const meta = document.createElement('div'); meta.className='post-header-meta';
    const nameDiv = document.createElement('div'); nameDiv.className='post-username';
    const nameLink = document.createElement('a'); nameLink.href = '#'; nameLink.textContent = username || '(ฉัน)';
    nameDiv.appendChild(nameLink);
    const timeDiv = document.createElement('div'); timeDiv.className='post-time small'; timeDiv.textContent = createdAt || '';
    meta.appendChild(nameDiv); meta.appendChild(timeDiv);
    header.appendChild(meta);

    art.appendChild(header);

    // body
    const body = document.createElement('div'); body.className='post-body';
    const contentDiv = document.createElement('div'); contentDiv.className='post-content';
    contentDiv.innerHTML = contentHtml || '';
    body.appendChild(contentDiv);

    if (images && images.length) {
      if (images.length === 1) {
        const im = document.createElement('img');
        im.className = 'post-img';
        im.src = images[0];
        im.alt = 'post image';
        im.loading = 'lazy';
        body.appendChild(im);
      } else {
        const gallery = document.createElement('div');
        gallery.className = 'post-gallery';
        for (const src of images) {
          const im = document.createElement('img');
          im.className = 'post-img';
          im.src = src;
          im.alt = 'post image';
          im.loading = 'lazy';
          gallery.appendChild(im);
        }
        body.appendChild(gallery);
      }
    }

    art.appendChild(body);
    return art;
  }

  async function getMyProfile() {
    try {
      const r = await fetch('/api/profile');
      if (!r.ok) return null;
      const j = await r.json();
      if (j && j.success) return j.profile;
    } catch (e) {}
    return null;
  }

  // render selected thumbnails
  function renderSelectedThumbnails() {
    selectedImages.innerHTML = '';
    for (const item of files) {
      const box = document.createElement('div');
      box.className = 'image-thumb';
      box.dataset.fileId = item.id;

      const img = document.createElement('img');
      img.src = item.url;
      img.alt = item.file.name || '';
      box.appendChild(img);

      const btn = document.createElement('button');
      btn.className = 'remove';
      btn.title = 'ลบรูปนี้';
      btn.innerText = '✕';
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        // remove only this item using its id
        removeFileById(item.id);
      });
      box.appendChild(btn);
      selectedImages.appendChild(box);
    }
  }

  function removeFileById(id) {
    const idx = files.findIndex(x => x.id === id);
    if (idx === -1) return;
    // revoke object URL
    try { URL.revokeObjectURL(files[idx].url); } catch(e){}
    files.splice(idx,1);
    renderSelectedThumbnails();
    updatePreview();
  }

  // gather image srcs for preview (stored urls)
  function previewImageSrcs() {
    return files.map(f => f.url);
  }

  // update live preview
  let profileCache = null;
  async function updatePreview() {
    const content = escapeHtml(contentInput.value).replace(/\n/g,'<br>');
    if (!profileCache) profileCache = await getMyProfile();
    const username = profileCache ? (profileCache.username || '(ฉัน)') : '(ฉัน)';
    const avatar = profileCache ? (profileCache.profilePic || '/img/default_profile.png') : '/img/default_profile.png';
    const images = previewImageSrcs();
    const art = makePreviewArticle(username, avatar, content, images, formatNow());
    previewPost.innerHTML = '';
    previewPost.appendChild(art);
  }

  // file input change
  fileInput.addEventListener('change', (ev) => {
    const list = Array.from(ev.target.files || []);
    for (const f of list) {
      const url = URL.createObjectURL(f);
      files.push({ id: genId(), file: f, url });
    }
    renderSelectedThumbnails();
    updatePreview();
    // reset input so same file can be re-selected if removed
    fileInput.value = '';
  });

  // clicking the label forwards click to hidden input
  chooseFilesBtn.addEventListener('click', (e) => {
    fileInput.click();
  });

  // live update when typing
  contentInput.addEventListener('input', () => updatePreview());

  // initialize preview
  (async function initPreview(){
    profileCache = await getMyProfile();
    updatePreview();
  })();

  // submit handler
  postForm.addEventListener('submit', async function(e){
    e.preventDefault();
    msg.style.color = '#000';
    msg.innerText = 'กำลังอัปโหลด...';
    const fd = new FormData();
    fd.append('content', contentInput.value || '');
    // append each file under two kinds of fields to maximize backend compatibility
    for (const item of files) {
      fd.append('postImage', item.file);         // common single-field multiple entries
      fd.append('postImages[]', item.file);      // array style
    }
    try {
      const res = await fetch('/api/post/create', { method: 'POST', body: fd });
      const data = await res.json();
      if (data && data.success) {
        msg.style.color = '#080';
        msg.innerText = 'โพสต์สำเร็จ';
        setTimeout(() => location.replace('/post/' + (data.postId || '')), 900);
      } else {
        msg.style.color = '#d00';
        msg.innerText = data && data.msg ? data.msg : 'ไม่สำเร็จ ลองอีกครั้ง';
      }
    } catch (err) {
      msg.style.color = '#d00';
      msg.innerText = 'เกิดข้อผิดพลาดเครือข่าย';
    }
  });

})();
</script>
</body>
</html>