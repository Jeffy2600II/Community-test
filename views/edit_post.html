<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>แก้ไขโพสต์</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      .image-gallery { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
      .image-thumb { position:relative; width:120px; height:90px; border-radius:8px; overflow:hidden; background:#f6f7fb; display:flex;align-items:center;justify-content:center; }
      .image-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
      .image-thumb button.remove { position:absolute; top:6px; right:6px; background:rgba(0,0,0,0.6); color:#fff; border:none; width:26px; height:26px; border-radius:6px; cursor:pointer; }
      textarea[name="content"] { min-height:140px; width:100%; padding:10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); font-size:1rem; }
      .small-note { color:var(--muted); font-size:0.92rem; margin-top:8px; }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container" style="max-width:800px;margin-top:24px;">
      <div class="card">
        <div class="section-title"><span>แก้ไขโพสต์</span></div>
        <form id="editPostForm" enctype="multipart/form-data">
            <label class="small">เนื้อหา</label>
            <textarea name="content" id="contentInput" placeholder="เนื้อหา"></textarea>

            <div class="input-file mt-16">
              <label class="btn btn-ghost" id="chooseFilesBtn">
                เพิ่มรูปภาพเพิ่มเติม <input id="fileInput" type="file" name="postImage" multiple style="display:none">
              </label>
              <span class="small-note">คุณสามารถลบรูปเดิมหรือเพิ่มรูปใหม่ได้</span>
            </div>

            <div id="selectedImages" class="image-gallery" aria-live="polite" aria-label="รูปที่เลือก"></div>

            <!-- container for hidden inputs to signal deletion of existing images -->
            <div id="deleteMarkers"></div>

            <div class="text-right mt-16">
              <button type="submit" class="btn btn-primary">อัปเดต</button>
            </div>
            <p id="msg" class="small" style="margin-top:8px"></p>
        </form>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
(function(){
  const postId = (location.pathname.split('/').slice(-2)[0] || '').replace(/[^a-zA-Z0-9\-_]/g,'');
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
  function formatNow(){ return new Date().toLocaleString(); }
  function genId() { return 'id_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*10000).toString(36); }

  const contentInput = document.getElementById('contentInput');
  const fileInput = document.getElementById('fileInput');
  const selectedImages = document.getElementById('selectedImages');
  const deleteMarkers = document.getElementById('deleteMarkers');
  const msg = document.getElementById('msg');
  const editForm = document.getElementById('editPostForm');
  const chooseFilesBtn = document.getElementById('chooseFilesBtn');

  // state
  let newFiles = []; // [{id, file, url}]
  let existingImages = []; // [{id, url}] (existing on server)
  let profileCache = null;

  async function getMyProfile() {
    try {
      const r = await fetch('/api/profile');
      if (!r.ok) return null;
      const j = await r.json();
      if (j && j.success) return j.profile;
    } catch (e) {}
    return null;
  }

  function createThumbBox(item, isExisting) {
    const box = document.createElement('div'); box.className = 'image-thumb';
    box.dataset.thumbId = item.id;

    const img = document.createElement('img');
    img.src = item.url;
    img.alt = '';
    box.appendChild(img);

    const btn = document.createElement('button'); btn.className = 'remove'; btn.innerText = '✕'; btn.title='ลบรูป';
    btn.addEventListener('click', (ev) => {
      ev.preventDefault();
      if (isExisting) removeExistingImage(item.id);
      else removeNewFile(item.id);
    });
    box.appendChild(btn);
    return box;
  }

  function renderThumbnails() {
    selectedImages.innerHTML = '';
    // existing first
    for (const e of existingImages) {
      selectedImages.appendChild(createThumbBox(e, true));
    }
    // new files
    for (const f of newFiles) {
      selectedImages.appendChild(createThumbBox(f, false));
    }
  }

  function removeExistingImage(id) {
    // find image by id and mark for deletion (add hidden input)
    const idx = existingImages.findIndex(x => x.id === id);
    if (idx === -1) return;
    const img = existingImages[idx];
    // create a delete marker value — use the exact url so server can match it
    const marker = document.createElement('input');
    marker.type = 'hidden';
    marker.name = 'deleteImages[]';
    marker.value = img.url || img.id || '';
    deleteMarkers.appendChild(marker);
    // remove from existingImages
    existingImages.splice(idx,1);
    renderThumbnails();
  }

  function removeNewFile(id) {
    const idx = newFiles.findIndex(x => x.id === id);
    if (idx === -1) return;
    try { URL.revokeObjectURL(newFiles[idx].url); } catch(e){}
    newFiles.splice(idx,1);
    renderThumbnails();
  }

  function previewImageSrcs() {
    const srcs = [];
    for (const e of existingImages) srcs.push(e.url);
    for (const f of newFiles) srcs.push(f.url);
    return srcs;
  }

  function makePreviewArticle(username, avatarUrl, contentHtml, images, createdAt) {
    const art = document.createElement('article');
    art.className = 'post';
    art.setAttribute('data-preview','1');

    const header = document.createElement('div'); header.className='post-header';
    const avatarLink = document.createElement('a'); avatarLink.className='post-avatar'; avatarLink.href='#';
    const img = document.createElement('img'); img.className='avatar-img'; img.alt = username || '';
    img.src = avatarUrl || '/img/default_profile.png';
    avatarLink.appendChild(img);
    header.appendChild(avatarLink);

    const meta = document.createElement('div'); meta.className='post-header-meta';
    const nameDiv = document.createElement('div'); nameDiv.className='post-username';
    const nameLink = document.createElement('a'); nameLink.href = '#'; nameLink.textContent = username || '(ฉัน)';
    nameDiv.appendChild(nameLink);
    const timeDiv = document.createElement('div'); timeDiv.className='post-time small'; timeDiv.textContent = createdAt || '';
    meta.appendChild(nameDiv); meta.appendChild(timeDiv);
    header.appendChild(meta);

    art.appendChild(header);

    const body = document.createElement('div'); body.className='post-body';
    const contentDiv = document.createElement('div'); contentDiv.className='post-content';
    contentDiv.innerHTML = contentHtml || '';
    body.appendChild(contentDiv);

    if (images && images.length) {
      if (images.length === 1) {
        const im = document.createElement('img');
        im.className = 'post-img';
        im.src = images[0];
        im.alt = 'post image';
        im.loading = 'lazy';
        body.appendChild(im);
      } else {
        const gallery = document.createElement('div');
        gallery.className = 'post-gallery';
        for (const src of images) {
          const im = document.createElement('img');
          im.className = 'post-img';
          im.src = src;
          im.alt = 'post image';
          im.loading = 'lazy';
          gallery.appendChild(im);
        }
        body.appendChild(gallery);
      }
    }

    art.appendChild(body);
    return art;
  }

  async function updatePreview() {
    const contentHtml = escapeHtml(contentInput.value).replace(/\n/g,'<br>');
    if (!profileCache) profileCache = await getMyProfile();
    const username = profileCache ? (profileCache.username || '(ฉัน)') : '(ฉัน)';
    const avatar = profileCache ? (profileCache.profilePic || '/img/default_profile.png') : '/img/default_profile.png';
    const images = previewImageSrcs();
    const art = makePreviewArticle(username, avatar, contentHtml, images, formatNow());
    // attach or update preview card
    let container = document.getElementById('previewContainer');
    if (!container) {
      container = document.createElement('div'); container.id = 'previewContainer'; container.className = 'card mt-16';
      const title = document.createElement('div'); title.className='section-title'; title.innerHTML = '<span>ตัวอย่างโพสต์ (Preview)</span>';
      const area = document.createElement('div'); area.id = 'previewPostArea';
      container.appendChild(title); container.appendChild(area);
      editForm.parentElement.insertBefore(container, editForm.nextSibling);
    }
    const area = document.getElementById('previewPostArea');
    area.innerHTML = '';
    area.appendChild(art);
  }

  // load post data
  async function loadPost() {
    try {
      const r = await fetch('/api/post/' + encodeURIComponent(postId));
      if (!r.ok) { msg.innerText = 'ไม่สามารถโหลดโพสต์ได้'; return; }
      const j = await r.json();
      if (!j.success) { msg.innerText = 'ไม่พบโพสต์'; return; }
      const post = j.post || {};
      contentInput.value = post.content || '';
      // normalize images
      existingImages = [];
      const imgs = Array.isArray(post.images) ? post.images.slice() : (post.image ? [post.image] : []);
      for (const u of imgs) {
        existingImages.push({ id: genId(), url: u });
      }
      renderThumbnails();
      profileCache = j.myProfile || null;
      updatePreview();
    } catch (e) {
      console.error(e);
      msg.innerText = 'เกิดข้อผิดพลาดขณะโหลดโพสต์';
    }
  }

  // file input
  fileInput.addEventListener('change', (ev) => {
    const list = Array.from(ev.target.files || []);
    for (const f of list) {
      const url = URL.createObjectURL(f);
      newFiles.push({ id: genId(), file: f, url });
    }
    renderThumbnails();
    updatePreview();
    fileInput.value = '';
  });

  chooseFilesBtn.addEventListener('click', (e) => {
    fileInput.click();
  });

  // submit
  editForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msg.style.color = '#000'; msg.innerText = 'กำลังอัปเดต...';
    const fd = new FormData();
    fd.append('content', contentInput.value || '');
    // collect delete markers already added as hidden inputs
    const markers = Array.from(deleteMarkers.querySelectorAll('input[name="deleteImages[]"]')).map(i => i.value);
    for (const d of markers) fd.append('deleteImages[]', d);
    // append new files
    for (const nf of newFiles) {
      fd.append('postImage', nf.file);
      fd.append('postImages[]', nf.file);
    }
    try {
      const res = await fetch('/api/post/' + encodeURIComponent(postId) + '/edit', { method: 'POST', body: fd });
      const data = await res.json();
      if (data && data.success) {
        msg.style.color = '#080'; msg.innerText = 'อัปเดตสำเร็จ';
        setTimeout(() => location.replace('/post/' + postId), 800);
      } else {
        msg.style.color = '#d00'; msg.innerText = data && data.msg ? data.msg : 'ไม่สำเร็จ';
      }
    } catch (e) {
      msg.style.color = '#d00'; msg.innerText = 'เกิดข้อผิดพลาดเครือข่าย';
    }
  });

  // helper: preview update on input
  contentInput.addEventListener('input', () => updatePreview());

  // init
  loadPost();

})();
</script>
</body>
</html>