<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>แก้ไขโพสต์</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      /* keep styles consistent with create page */
      .image-gallery { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
      .image-thumb { position:relative; width:120px; height:90px; border-radius:8px; overflow:hidden; background:#f6f7fb; display:flex;align-items:center;justify-content:center; }
      .image-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
      .image-thumb button.remove { position:absolute; top:6px; right:6px; background:rgba(0,0,0,0.6); color:#fff; border:none; width:26px; height:26px; border-radius:6px; cursor:pointer; }
      textarea[name="content"] { min-height:140px; width:100%; padding:10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); font-size:1rem; }
      .small-note { color:var(--muted); font-size:0.92rem; margin-top:8px; }
      .image-thumb .badge { position:absolute; left:6px; top:6px; background: rgba(0,0,0,0.5); color:#fff; padding:2px 6px; border-radius:6px; font-size:12px; }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container" style="max-width:800px;margin-top:24px;">
      <div class="card">
        <div class="section-title"><span>แก้ไขโพสต์</span></div>
        <form id="editPostForm" enctype="multipart/form-data">
            <label class="small">เนื้อหา</label>
            <textarea name="content" id="contentInput" placeholder="เนื้อหา"></textarea>

            <div class="input-file mt-16">
              <label class="btn btn-ghost">
                เพิ่มรูปภาพเพิ่มเติม <input id="fileInput" type="file" name="postImage" multiple style="display:none">
              </label>
              <span class="small-note">คุณสามารถลบรูปเดิมหรือเพิ่มรูปใหม่ได้</span>
            </div>

            <div id="selectedImages" class="image-gallery" aria-live="polite" aria-label="รูปที่เลือกระหว่างแก้ไข"></div>

            <!-- container for hidden inputs to signal deletion of existing images -->
            <div id="deleteMarkers"></div>

            <div class="text-right mt-16">
              <button type="submit" class="btn btn-primary">อัปเดต</button>
            </div>
            <p id="msg" class="small" style="margin-top:8px"></p>
        </form>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
(function(){
  const postId = (location.pathname.split('/').slice(-2)[0] || '').replace(/[^a-zA-Z0-9\-_]/g,'');
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function formatNow(){ return new Date().toLocaleString(); }
  function genId(prefix='id'){ return prefix + '-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8); }

  const contentInput = document.getElementById('contentInput');
  const fileInput = document.getElementById('fileInput');
  const selectedImages = document.getElementById('selectedImages');
  const deleteMarkers = document.getElementById('deleteMarkers');
  const msg = document.getElementById('msg');
  const editForm = document.getElementById('editPostForm');

  // state
  let existingImages = []; // { id, url } - images already saved on server
  let newFiles = []; // { id, file, url } - newly added files in this edit session
  let profileCache = null;

  async function getMyProfile() {
    try {
      const r = await fetch('/api/profile');
      if (!r.ok) return null;
      const j = await r.json();
      if (j && j.success) return j.profile;
    } catch (e) {}
    return null;
  }

  function createThumbBoxForExisting(entry, index) {
    const box = document.createElement('div'); box.className = 'image-thumb';
    box.dataset.id = entry.id || entry.url;
    const img = document.createElement('img'); img.src = entry.url; img.alt = entry.url;
    box.appendChild(img);

    const badge = document.createElement('div'); badge.className = 'badge small'; badge.innerText = 'เดิม';
    box.appendChild(badge);

    const btn = document.createElement('button'); btn.className = 'remove'; btn.title='ลบรูป'; btn.innerText='✕';
    btn.dataset.id = entry.id || entry.url;
    btn.addEventListener('click', (ev) => {
      ev.preventDefault();
      const id = btn.dataset.id;
      // mark this existing image for deletion (backend will process deleteImages[])
      const marker = document.createElement('input');
      marker.type = 'hidden';
      marker.name = 'deleteImages[]';
      marker.value = entry.url || id;
      deleteMarkers.appendChild(marker);
      // remove from existingImages
      existingImages = existingImages.filter(e => (e.id || e.url) !== id);
      renderThumbnails();
      updatePreview();
    });
    box.appendChild(btn);
    return box;
  }

  function createThumbBoxForNew(entry) {
    const box = document.createElement('div'); box.className = 'image-thumb';
    box.dataset.id = entry.id;
    const img = document.createElement('img'); img.src = entry.url; img.alt = entry.file.name;
    box.appendChild(img);

    const btn = document.createElement('button'); btn.className = 'remove'; btn.title='ลบรูป'; btn.innerText='✕';
    btn.dataset.id = entry.id;
    btn.addEventListener('click', (ev) => {
      ev.preventDefault();
      const id = btn.dataset.id;
      const idx = newFiles.findIndex(f => f.id === id);
      if (idx !== -1) {
        const removed = newFiles.splice(idx, 1)[0];
        try { URL.revokeObjectURL(removed.url); } catch(e){}
        renderThumbnails();
        updatePreview();
      }
    });
    box.appendChild(btn);
    return box;
  }

  function renderThumbnails() {
    selectedImages.innerHTML = '';
    existingImages.forEach((e, idx) => {
      const box = createThumbBoxForExisting(e, idx);
      selectedImages.appendChild(box);
    });
    newFiles.forEach(n => {
      const box = createThumbBoxForNew(n);
      selectedImages.appendChild(box);
    });
  }

  function previewImageSrcs() {
    const out = [];
    for (const e of existingImages) out.push(e.url);
    for (const n of newFiles) out.push(n.url);
    return out;
  }

  function makePreviewArticle(username, avatarUrl, contentHtml, images, createdAt) {
    const art = document.createElement('article');
    art.className = 'post';
    art.setAttribute('data-preview','1');

    const header = document.createElement('div'); header.className='post-header';
    const avatarLink = document.createElement('a'); avatarLink.className='post-avatar'; avatarLink.href='#';
    const img = document.createElement('img'); img.className='avatar-img'; img.alt = username || '';
    img.src = avatarUrl || '/img/default_profile.png';
    avatarLink.appendChild(img);
    header.appendChild(avatarLink);

    const meta = document.createElement('div'); meta.className='post-header-meta';
    const nameDiv = document.createElement('div'); nameDiv.className='post-username';
    const nameLink = document.createElement('a'); nameLink.href = '#'; nameLink.textContent = username || '(ฉัน)';
    nameDiv.appendChild(nameLink);
    const timeDiv = document.createElement('div'); timeDiv.className='post-time small'; timeDiv.textContent = createdAt || '';
    meta.appendChild(nameDiv); meta.appendChild(timeDiv);
    header.appendChild(meta);

    art.appendChild(header);

    const body = document.createElement('div'); body.className='post-body';
    const contentDiv = document.createElement('div'); contentDiv.className='post-content';
    contentDiv.innerHTML = contentHtml || '';
    body.appendChild(contentDiv);

    if (images && images.length) {
      if (images.length === 1) {
        const im = document.createElement('img');
        im.className = 'post-img';
        im.src = images[0];
        im.alt = 'post image';
        im.loading = 'lazy';
        body.appendChild(im);
      } else {
        const gallery = document.createElement('div');
        gallery.className = 'post-gallery';
        for (const src of images) {
          const im = document.createElement('img');
          im.className = 'post-img';
          im.src = src;
          im.alt = 'post image';
          im.loading = 'lazy';
          gallery.appendChild(im);
        }
        body.appendChild(gallery);
      }
    }

    art.appendChild(body);
    return art;
  }

  async function updatePreview() {
    const contentHtml = escapeHtml(contentInput.value).replace(/\n/g,'<br>');
    if (!profileCache) profileCache = await getMyProfile();
    const username = profileCache ? (profileCache.username || '(ฉัน)') : '(ฉัน)';
    const avatar = profileCache ? (profileCache.profilePic || '/img/default_profile.png') : '/img/default_profile.png';
    const images = previewImageSrcs();
    // place preview below form if not present
    let previewArea = document.getElementById('editPreviewArea');
    if (!previewArea) {
      previewArea = document.createElement('div');
      previewArea.id = 'editPreviewArea';
      previewArea.className = 'card mt-16';
      const title = document.createElement('div');
      title.className = 'section-title';
      title.innerHTML = '<span>ตัวอย่างโพสต์ (Preview)</span>';
      previewArea.appendChild(title);
      const body = document.createElement('div');
      body.id = 'editPreviewBody';
      previewArea.appendChild(body);
      editForm.parentElement.insertBefore(previewArea, editForm.nextSibling);
    }
    const body = document.getElementById('editPreviewBody');
    body.innerHTML = '';
    body.appendChild(makePreviewArticle(username, avatar, contentHtml, images, formatNow()));
  }

  // load post data
  async function loadPost() {
    try {
      const r = await fetch('/api/post/' + encodeURIComponent(postId));
      if (!r.ok) { msg.innerText = 'ไม่สามารถโหลดโพสต์ได้'; return; }
      const j = await r.json();
      if (!j.success) { msg.innerText = 'ไม่พบโพสต์'; return; }
      const post = j.post || {};
      contentInput.value = post.content || '';
      // existing images: use images array or legacy image
      existingImages = [];
      if (Array.isArray(post.images) && post.images.length) {
        existingImages = post.images.map(u => ({ id: u, url: u }));
      } else if (post.image) {
        existingImages = [{ id: post.image, url: post.image }];
      }
      renderThumbnails();
      profileCache = j.myUsername ? null : null;
      // load profile separately in updatePreview
      profileCache = await getMyProfile();
      updatePreview();
    } catch (e) {
      console.error(e);
      msg.innerText = 'เกิดข้อผิดพลาดขณะโหลดโพสต์';
    }
  }

  // file input
  fileInput.addEventListener('change', (ev) => {
    const list = Array.from(ev.target.files || []);
    for (const f of list) {
      const id = genId('new');
      const url = URL.createObjectURL(f);
      newFiles.push({ id, file: f, url });
    }
    renderThumbnails();
    updatePreview();
    fileInput.value = '';
  });

  // submit
  editForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msg.style.color = '#000'; msg.innerText = 'กำลังอัปเดต...';
    const fd = new FormData();
    fd.append('content', contentInput.value || '');
    // include deleteMarkers (we already appended hidden inputs to DOM, but since we're building FormData manually, collect them)
    const deletes = Array.from(deleteMarkers.querySelectorAll('input[name="deleteImages[]"]')).map(i => i.value);
    deletes.forEach(d => fd.append('deleteImages[]', d));
    // append new files
    newFiles.forEach(n => {
      fd.append('postImage', n.file);
      fd.append('postImages[]', n.file);
    });
    try {
      const res = await fetch('/api/post/' + encodeURIComponent(postId) + '/edit', { method: 'POST', body: fd });
      const data = await res.json();
      if (data && data.success) {
        msg.style.color = '#080'; msg.innerText = 'อัปเดตสำเร็จ';
        setTimeout(() => location.replace('/post/' + postId), 800);
      } else {
        msg.style.color = '#d00'; msg.innerText = data && data.msg ? data.msg : 'ไม่สำเร็จ';
      }
    } catch (e) {
      msg.style.color = '#d00'; msg.innerText = 'เกิดข้อผิดพลาดเครือข่าย';
    }
  });

  // helper to ensure preview updates when typing
  contentInput.addEventListener('input', () => updatePreview());

  // cleanup object URLs on unload
  window.addEventListener('beforeunload', () => {
    newFiles.forEach(f => { try { if (f.url && f.url.startsWith('blob:')) URL.revokeObjectURL(f.url); } catch(e){} });
  });

  // initial load
  loadPost();

})();
</script>
</body>
</html>