<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>แก้ไขโปรไฟล์</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container" style="max-width:720px;margin-top:20px;">
      <div class="card">
        <div class="section-title"><span>แก้ไขโปรไฟล์</span></div>
        <form id="editProfileForm">
            <label class="small">ชื่อที่แสดง</label>
            <input type="text" name="displayName" placeholder="ชื่อที่แสดง">
            <label class="small">อีเมล (จะเห็นเมื่อตั้งค่าแสดง)</label>
            <input type="email" name="email" placeholder="อีเมล">
            <div class="mt-16">
              <label><input type="checkbox" name="showEmail" id="showEmail"> แสดงอีเมลในโปรไฟล์สาธารณะ</label>
            </div>
            <div class="text-right mt-16">
              <button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
            <p id="msg" class="small mt-16"></p>
        </form>
        <hr class="mt-16">
        <div class="profile-pic-box text-center">
          <img id="avatarPreviewCrop" src="/img/default_profile.png" alt="โปรไฟล์" width="120" height="120" style="border-radius:50%;background:#eee;">
          <div class="profile-edit-btns row mt-16" id="picButtons">
            <button id="uploadPicBtn" class="btn btn-primary" type="button" style="display:none;">อัปโหลดรูปโปรไฟล์</button>
            <button id="editPicBtn" class="btn btn-primary" type="button" style="display:none;">แก้ไขโปรไฟล์</button>
            <button id="removePicBtn" type="button" class="btn btn-ghost" style="display:none;">ลบรูป</button>
          </div>
          <div id="inlineMsg" role="status" aria-live="polite"></div>
        </div>
        <!-- Modal: เลือกว่าจะอัปโหลดใหม่หรือแก้ไข -->
        <div id="chooseEditModal" class="modal-fullscreen-bg hidden" aria-hidden="true">
          <div class="modal-fullscreen-content" role="dialog" aria-modal="true">
            <h3>แก้ไขรูปโปรไฟล์</h3>
            <div style="margin:20px 0; display:flex; flex-direction:column; gap:10px; width:100%; align-items:center;">
              <button id="btnUploadNew" class="btn btn-primary" style="width:60%;">อัปโหลดรูปใหม่</button>
              <button id="btnEditCurrent" class="btn btn-ghost" style="width:60%;">แก้ไขรูปโปรไฟล์ปัจจุบัน</button>
            </div>
            <button id="btnChooseEditCancel" class="btn btn-ghost">ยกเลิก</button>
          </div>
        </div>
        <!-- Modal: Cropper -->
        <div id="cropperModal" class="modal-fullscreen-bg hidden" aria-hidden="true">
          <div class="modal-fullscreen-content" role="dialog" aria-modal="true">
            <h3 id="cropperModalTitle">ปรับตำแหน่งรูปโปรไฟล์</h3>
            <div style="display:flex; gap:16px; width:100%; justify-content:center; align-items:flex-start; flex-wrap:wrap;">
              <img id="cropperImage" src="" alt="Crop" aria-hidden="false">
            </div>
            <div class="modal-btns row mt-16" style="justify-content:center;">
              <button id="btnCropSave" class="btn btn-primary">บันทึก</button>
              <button id="btnCropCancel" class="btn btn-ghost">ยกเลิก</button>
            </div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none;">
          </div>
        </div>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>
<script src="/js/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script>
let cropper = null;
let croppedBlob = null;
let lastFile = null;
let currentProfilePicUrl = '';
let currentProfilePicOriginalUrl = '';
let originalBlob = null;
let prevPreviewSrc = '';
let tempObjectUrl = null;

function showChooseModal(show) {
  const el = document.getElementById('chooseEditModal');
  el.classList.toggle('hidden', !show);
  el.setAttribute('aria-hidden', !show);
}
function showCropperModal(show) {
  const el = document.getElementById('cropperModal');
  el.classList.toggle('hidden', !show);
  el.setAttribute('aria-hidden', !show);
}
function updatePicButtons() {
  const hasPic = !!currentProfilePicUrl && currentProfilePicUrl !== '/img/default_profile.png';
  document.getElementById('uploadPicBtn').style.display = hasPic ? 'none' : 'inline-block';
  document.getElementById('editPicBtn').style.display = hasPic ? 'inline-block' : 'none';
  document.getElementById('removePicBtn').style.display = hasPic ? 'inline-block' : 'none';
}
function setInlineMsg(text) {
  const el = document.getElementById('inlineMsg');
  if (!text) { el.style.display = 'none'; el.textContent = ''; }
  else { el.style.display = 'block'; el.textContent = text; }
}
function setupCropper(imgEl) {
  if (cropper) { cropper.destroy(); cropper = null; }
  cropper = new Cropper(imgEl, {
    aspectRatio: 1,
    viewMode: 1,
    dragMode: 'move',
    autoCropArea: 1,
    minCropBoxWidth: 120,
    minCropBoxHeight: 120,
    movable: true,
    scalable: true,
    zoomable: true,
    rotatable: false,
    cropBoxResizable: true,
    background: false,
    guides: false,
    highlight: false,
    center: true,
    crop() {
      const canvas = cropper.getCroppedCanvas({ width: 400, height: 400, imageSmoothingQuality: 'high' });
      if (!canvas) return;
      const preview = document.getElementById('avatarPreviewCrop');
      preview.style.display = 'block';
      preview.src = canvas.toDataURL('image/jpeg', 0.92);
      canvas.toBlob(function(blob){ croppedBlob = blob; }, 'image/jpeg', 0.92);
    }
  });
}
async function openCropperModal(file, fromCurrent = false) {
  const previewEl = document.getElementById('avatarPreviewCrop');
  prevPreviewSrc = previewEl.src || '';
  const imgEl = document.getElementById('cropperImage');
  if (tempObjectUrl) {
    try { URL.revokeObjectURL(tempObjectUrl); } catch(e) {}
    tempObjectUrl = null;
  }
  if (fromCurrent) {
    if (currentProfilePicOriginalUrl) {
      try {
        const r = await fetch(currentProfilePicOriginalUrl + '?t=' + Date.now());
        if (!r.ok) throw new Error('fetch original failed');
        const blob = await r.blob();
        originalBlob = blob;
        tempObjectUrl = URL.createObjectURL(blob);
        imgEl.src = tempObjectUrl;
        showCropperModal(true);
        imgEl.onload = () => setupCropper(imgEl);
      } catch (e) {
        originalBlob = null;
        if (currentProfilePicUrl) {
          tempObjectUrl = currentProfilePicUrl + '?t=' + Date.now();
          imgEl.src = tempObjectUrl;
          showCropperModal(true);
          imgEl.onload = () => setupCropper(imgEl);
        } else {
          setInlineMsg('ไม่พบรูปต้นฉบับสำหรับแก้ไข โปรดอัปโหลดรูปใหม่');
        }
      }
    } else {
      setInlineMsg('ไม่มีรูปต้นฉบับให้แก้ไข (original) — โปรดอัปโหลดรูปใหม่');
    }
  } else {
    if (!file) return;
    lastFile = file;
    originalBlob = file;
    tempObjectUrl = URL.createObjectURL(file);
    imgEl.src = tempObjectUrl;
    showCropperModal(true);
    imgEl.onload = () => setupCropper(imgEl);
  }
}
function closeCropperModalAndCleanup() {
  if (cropper) { cropper.destroy(); cropper = null; }
  const imgEl = document.getElementById('cropperImage');
  imgEl.src = '';
  showCropperModal(false);
  if (tempObjectUrl && tempObjectUrl.startsWith('blob:')) {
    try { URL.revokeObjectURL(tempObjectUrl); } catch(e) {}
  }
  tempObjectUrl = null;
  setInlineMsg('');
}
document.getElementById('uploadPicBtn').addEventListener('click', function() {
  setInlineMsg('');
  document.getElementById('avatarInput').value = '';
  document.getElementById('avatarInput').click();
});
document.getElementById('editPicBtn').addEventListener('click', function() {
  setInlineMsg('');
  showChooseModal(true);
});
document.getElementById('btnChooseEditCancel').addEventListener('click', function() {
  showChooseModal(false);
});
document.getElementById('btnUploadNew').addEventListener('click', function() {
  showChooseModal(false);
  document.getElementById('avatarInput').value = '';
  document.getElementById('avatarInput').click();
});
document.getElementById('btnEditCurrent').addEventListener('click', function() {
  showChooseModal(false);
  openCropperModal(null, true);
});
document.getElementById('avatarInput').addEventListener('change', function(e) {
  const file = this.files[0];
  if (!file) return;
  openCropperModal(file, false);
});
document.getElementById('btnCropSave').addEventListener('click', async function() {
  if (!cropper) return;
  const canvas = cropper.getCroppedCanvas({ width: 800, height: 800, imageSmoothingQuality: 'high' });
  if (!canvas) { setInlineMsg('ไม่สามารถตัดภาพได้'); return; }
  canvas.toBlob(async function(blob) {
    croppedBlob = blob;
    const preview = document.getElementById('avatarPreviewCrop');
    preview.src = canvas.toDataURL('image/jpeg', 0.92);
    const fd = new FormData();
    fd.append('profilePic', croppedBlob, 'avatar.jpg');
    if (originalBlob) {
      fd.append('original', originalBlob, 'original.jpg');
    }
    try {
      const res = await fetch('/api/profile/upload-pic', { method: 'POST', body: fd });
      const data = await res.json();
      if (data && data.success) {
        if (data.url) {
          currentProfilePicUrl = data.url;
          preview.src = data.url + '?t=' + Date.now();
        }
        if (data.original) currentProfilePicOriginalUrl = data.original;
        closeCropperModalAndCleanup();
        updatePicButtons();
        location.reload();
      } else {
        setInlineMsg((data && data.msg) ? data.msg : 'เกิดข้อผิดพลาดในการอัปโหลด');
        preview.src = prevPreviewSrc || '/img/default_profile.png';
        closeCropperModalAndCleanup();
      }
    } catch (e) {
      setInlineMsg('การเชื่อมต่อไปยังเซิร์ฟเวอร์ล้มเหลว');
      preview.src = prevPreviewSrc || '/img/default_profile.png';
      closeCropperModalAndCleanup();
    }
  }, 'image/jpeg', 0.92);
});
document.getElementById('btnCropCancel').addEventListener('click', function() {
  const ok = confirm('คุณต้องการยกเลิกใช่หรือไม่? ระบบจะยกเลิกการอัปโหลดรูปนี้และกลับไปใช้รูปเดิม');
  if (!ok) return;
  const preview = document.getElementById('avatarPreviewCrop');
  preview.src = prevPreviewSrc || '/img/default_profile.png';
  croppedBlob = null;
  lastFile = null;
  originalBlob = null;
  if (tempObjectUrl && tempObjectUrl.startsWith('blob:')) {
    try { URL.revokeObjectURL(tempObjectUrl); } catch(e) {}
  }
  tempObjectUrl = null;
  document.getElementById('avatarInput').value = '';
  closeCropperModalAndCleanup();
});
document.getElementById('removePicBtn').addEventListener('click', async function() {
  if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบรูปโปรไฟล์?')) return;
  try {
    const res = await fetch('/api/profile/remove-pic', { method: 'POST' });
    const d = await res.json();
    if (d && d.success) {
      document.getElementById('avatarPreviewCrop').src = '/img/default_profile.png';
      currentProfilePicUrl = '';
      currentProfilePicOriginalUrl = '';
      updatePicButtons();
      location.reload();
    } else {
      setInlineMsg('ลบรูปไม่สำเร็จ');
    }
  } catch (e) {
    setInlineMsg('เกิดข้อผิดพลาดขณะลบรูป');
  }
});
(async function init() {
  try {
    const pr = await fetch('/api/profile');
    if (!pr.ok) { location.href = '/login'; return; }
    const data = await pr.json();
    if (!data.success) return;
    const { profile } = data;
    document.querySelector('input[name=displayName]').value = profile.displayName || '';
    document.querySelector('input[name=email]').value = profile.email || '';
    document.getElementById('showEmail').checked = !!profile.showEmail;
    currentProfilePicUrl = profile.profilePic && profile.profilePic !== '' ? profile.profilePic : '';
    currentProfilePicOriginalUrl = profile.profilePicOriginal && profile.profilePicOriginal !== '' ? profile.profilePicOriginal : '';
    const previewEl = document.getElementById('avatarPreviewCrop');
    if (currentProfilePicUrl) previewEl.src = currentProfilePicUrl + '?t=' + Date.now();
    else previewEl.src = '/img/default_profile.png';
    updatePicButtons();
  } catch (e) {}
})();
document.getElementById('editProfileForm').onsubmit = async function(e) {
  e.preventDefault();
  const msg = document.getElementById('msg');
  msg.textContent = '';
  const fd = new FormData(this);
  const body = Object.fromEntries(fd.entries());
  body.showEmail = document.getElementById('showEmail').checked;
  try {
    const res = await fetch('/api/profile/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data && data.success) {
      msg.style.color = '#080';
      msg.textContent = 'บันทึกสำเร็จ';
    } else {
      msg.style.color = '#d00';
      msg.textContent = data && data.msg ? data.msg : 'เกิดข้อผิดพลาด';
    }
  } catch (err) {
    msg.style.color = '#d00';
    msg.textContent = 'เกิดข้อผิดพลาดเครือข่าย';
  }
};
</script>
</body>
</html>