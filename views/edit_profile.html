<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>แก้ไขโปรไฟล์</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      main { max-width:720px; margin:1.2em auto; padding:1.2em; }
      .form-row { margin-bottom:.8rem; }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
      <div class="section-title"><span>แก้ไขโปรไฟล์</span></div>
      <form id="editProfileForm">
          <div class="form-row"><input type="text" name="displayName" placeholder="ชื่อที่แสดง"></div>
          <div class="form-row"><input type="email" name="email" placeholder="อีเมล (จะเห็นเมื่อตั้งค่าแสดง)"></div>
          <div class="form-row">
            <label><input type="checkbox" name="showEmail" id="showEmail"> แสดงอีเมลในโปรไฟล์สาธารณะ</label>
          </div>
          <button type="submit">บันทึก</button>
          <p id="msg"></p>
      </form>

      <form id="picForm" enctype="multipart/form-data">
          <label>รูปโปรไฟล์: <input type="file" name="profilePic"></label>
          <button type="submit">อัปโหลด</button>
          <button id="removePicBtn" type="button">ลบรูป</button>
      </form>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
(async ()=>{
    // load existing profile
    const pr = await fetch('/api/profile');
    if (!pr.ok) { location.href = '/login'; return; }
    const data = await pr.json();
    if (!data.success) return;
    const { profile } = data;
    document.querySelector('input[name=displayName]').value = profile.displayName || '';
    document.querySelector('input[name=email]').value = profile.email || '';
    document.getElementById('showEmail').checked = !!profile.showEmail;
})();

document.getElementById('editProfileForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const body = {
        displayName: fd.get('displayName'),
        email: fd.get('email'),
        showEmail: document.getElementById('showEmail').checked
    };
    const res = await fetch('/api/profile/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    const data = await res.json();
    document.getElementById('msg').innerText = data.success ? 'บันทึกสำเร็จ' : (data.msg || 'ผิดพลาด');
    if (data.success) setTimeout(() => location.replace('/profile'), 800);
};

document.getElementById('picForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/profile/upload-pic', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.success) alert('อัปโหลดสำเร็จ!'); else alert('ผิดพลาด');
};

document.getElementById('removePicBtn').onclick = async () => {
    if (!confirm('ลบรูปโปรไฟล์?')) return;
    await fetch('/api/profile/remove-pic', { method: 'POST' });
    location.reload();
};
</script>
</body>
</html>