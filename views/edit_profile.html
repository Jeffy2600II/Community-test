<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <title>แก้ไขโปรไฟล์</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container" style="max-width:720px;margin-top:20px;">
      <div class="card">
        <div class="section-title"><span>แก้ไขโปรไฟล์</span></div>
        <form id="editProfileForm">
            <label class="small">ชื่อที่แสดง</label>
            <input type="text" name="displayName" placeholder="ชื่อที่แสดง">
            <label class="small">อีเมล (จะเห็นเมื่อตั้งค่าแสดง)</label>
            <input type="email" name="email" placeholder="อีเมล">
            <div style="margin-top:8px">
              <label><input type="checkbox" name="showEmail" id="showEmail"> แสดงอีเมลในโปรไฟล์สาธารณะ</label>
            </div>
            <div style="text-align:right;margin-top:12px">
              <button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
            <p id="msg" class="small" style="margin-top:8px"></p>
        </form>

        <hr style="margin:18px 0;">

        <form id="picForm" enctype="multipart/form-data">
            <label class="small">รูปโปรไฟล์</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <label class="btn btn-ghost">เลือกไฟล์ <input type="file" name="profilePic"></label>
              <button type="submit" class="btn btn-primary">อัปโหลด</button>
              <button id="removePicBtn" type="button" class="btn btn-ghost">ลบรูป</button>
            </div>
        </form>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
(async ()=>{
    const pr = await fetch('/api/profile');
    if (!pr.ok) { location.href = '/login'; return; }
    const data = await pr.json();
    if (!data.success) return;
    const { profile } = data;
    document.querySelector('input[name=displayName]').value = profile.displayName || '';
    document.querySelector('input[name=email]').value = profile.email || '';
    document.getElementById('showEmail').checked = !!profile.showEmail;
})();

document.getElementById('editProfileForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const body = {
        displayName: fd.get('displayName'),
        email: fd.get('email'),
        showEmail: document.getElementById('showEmail').checked
    };
    const res = await fetch('/api/profile/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    const data = await res.json();
    document.getElementById('msg').innerText = data.success ? 'บันทึกสำเร็จ' : (data.msg || 'ผิดพลาด');
    if (data.success) setTimeout(() => location.replace('/profile'), 800);
};

document.getElementById('picForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/profile/upload-pic', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.success) alert('อัปโหลดสำเร็จ!'); else alert('ผิดพลาด');
};

document.getElementById('removePicBtn').onclick = async () => {
    if (!confirm('ลบรูปโปรไฟล์?')) return;
    await fetch('/api/profile/remove-pic', { method: 'POST' });
    location.reload();
};
</script>
</body>
</html>