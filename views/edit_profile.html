<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>แก้ไขโปรไฟล์</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header>
    <h1><a href="/">COMMUNITY</a></h1>
    <nav>
        <a href="/">หน้าแรก</a>
        <a href="/profile">โปรไฟล์</a>
        <a href="#" id="logoutBtn">ออกจากระบบ</a>
    </nav>
</header>
<main>
    <div class="section-title"><span>แก้ไขโปรไฟล์</span></div>
    <form id="editProfileForm">
        <input type="text" name="displayName" placeholder="ชื่อที่แสดง">
        <input type="email" name="email" placeholder="อีเมล">
        <button type="submit">บันทึก</button>
        <p id="msg"></p>
    </form>
    <form id="picForm" enctype="multipart/form-data">
        <label>รูปโปรไฟล์: <input type="file" name="profilePic"></label>
        <button type="submit">อัปโหลด</button>
        <button id="removePicBtn" type="button">ลบรูป</button>
    </form>
</main>
<script>
document.getElementById('logoutBtn').onclick = async () => {
    await fetch('/api/logout', { method: 'POST' });
    location.replace('/');
};
(async ()=>{
    const pr = await fetch('/api/profile');
    const { profile } = await pr.json();
    document.querySelector('input[name=displayName]').value = profile.displayName || '';
    document.querySelector('input[name=email]').value = profile.email || '';
})();
document.getElementById('editProfileForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/profile/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.fromEntries(fd.entries()))
    });
    const data = await res.json();
    document.getElementById('msg').innerText = data.success ? 'บันทึกสำเร็จ' : 'ผิดพลาด';
    if (data.success) setTimeout(() => location.reload(), 1000);
};
document.getElementById('picForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/profile/upload-pic', {
        method: 'POST',
        body: fd
    });
    const data = await res.json();
    if (data.success) alert('อัปโหลดสำเร็จ!'); else alert('ผิดพลาด');
};
document.getElementById('removePicBtn').onclick = async () => {
    if (confirm('ลบรูป?')) {
        await fetch('/api/profile/remove-pic', { method: 'POST' });
        location.reload();
    }
};
</script>
</body>
</html>