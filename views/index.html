<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Community Home</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* excerpt clamp (used to visually shorten long content in feed) */
    .post-excerpt a.post-link {
      color: inherit;
      text-decoration: none;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      -webkit-line-clamp: 5; /* number of visible lines before truncation */
    }
    .post-excerpt a.post-link:hover { text-decoration: underline; }

    /* Kebab (three-dot) button placed at the far left of the header */
    .post {
      position: relative; /* popup will be positioned relative to the post */
    }
    .post-header {
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
    }
    .post-kebab {
      background: transparent;
      border: none;
      cursor: pointer;
      width:36px;
      height:36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      margin-right: -4px; /* tuck closer to avatar visually */
    }
    .post-kebab:focus { outline: 2px solid rgba(47,128,237,0.12); }

    .post-popup {
      position: absolute;
      left: 8px; /* appear near left edge */
      top: 44px;
      background: var(--surface);
      border: 1px solid rgba(15,23,42,0.06);
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(16,24,40,0.08);
      min-width: 160px;
      z-index: 2200;
      overflow: hidden;
    }
    .post-popup button, .post-popup a {
      display: block;
      width: 100%;
      padding: 10px 12px;
      text-align: left;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
    }
    .post-popup button:hover, .post-popup a:hover { background: #fbfdff; }
    /* small helper to ensure avatar isn't bumped by kebab */
    .post-header .post-avatar { margin-left: 0; }

    /* ensure image fits nicely in feed */
    .post .post-img { margin-top: 12px; max-width: 100%; height: auto; }

    /* ensure actions area doesn't show edit/delete buttons inline */
    .post-actions { margin-top: 12px; display:flex; gap:8px; align-items:center; visibility: hidden; height: 0; }
  </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container">
      <div class="card">
        <div class="section-title"><span>ฟีดโพสต์ล่าสุด</span></div>
        <div id="feed" class="feed">
          <i class="small">กำลังโหลด...</i>
        </div>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

  <script src="/js/main.js"></script>
  <script>
  (function () {
    // Utility to escape text for safe HTML insertion
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s).replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]);
      });
    }

    let myUsername = null;

    async function loadProfile() {
      try {
        const pr = await fetch('/api/profile');
        if (!pr.ok) return null;
        const data = await pr.json();
        if (data && data.success && data.profile) return data.profile.username;
      } catch (e) {}
      return null;
    }

    // Render posts into the feed container
    async function renderFeed() {
      myUsername = await loadProfile();
      const res = await fetch('/api/posts');
      const data = await res.json();
      const posts = (data && data.posts) || [];
      const feed = document.getElementById('feed');
      feed.innerHTML = '';

      if (!posts.length) {
        feed.innerHTML = '<i class="small">ยังไม่มีโพสต์</i>';
        return;
      }

      for (let post of posts) {
        const art = document.createElement('article');
        art.className = 'post';
        art.dataset.postId = post.id;
        art.dataset.postOwner = post.username || '';
        art.innerHTML = `
          <div class="post-header" role="group" aria-label="ผู้โพสต์">
            <button class="post-kebab" aria-haspopup="true" aria-expanded="false" title="ตัวเลือกเพิ่มเติม" data-post-id="${escapeHtml(post.id)}" aria-label="เมนูโพสต์">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#97a0b3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>

            <a class="post-avatar" href="/user/${encodeURIComponent(post.username)}" aria-hidden="false" style="display:inline-flex;align-items:center;">
              <img src="/img/default_profile.png" class="avatar-img" alt="${escapeHtml(post.username)}" id="avatar-${escapeHtml(post.username)}-${escapeHtml(post.id)}">
            </a>

            <div class="post-header-meta">
              <div class="post-username"><a href="/user/${encodeURIComponent(post.username)}">${escapeHtml(post.username)}</a></div>
              <div class="post-time small">${new Date(post.createdAt).toLocaleString()}</div>
            </div>
          </div>

          <div class="post-body">
            <div class="post-excerpt"><a class="post-link" href="/post/${encodeURIComponent(post.id)}">${escapeHtml((post.content || '').slice(0, 1000))}</a></div>
            ${post.image ? `<img src="${post.image}" class="post-img" alt="post image" loading="lazy">` : ''}
            <div class="post-actions"></div>
          </div>
        `;

        // attach to feed
        feed.appendChild(art);

        // load avatar asynchronously (same approach as before)
        (async () => {
          try {
            const up = await fetch(`/api/user/${encodeURIComponent(post.username)}`);
            const ud = await up.json();
            if (ud && ud.success && ud.profile && ud.profile.profilePic) {
              const imgElem = document.getElementById("avatar-" + post.username + "-" + post.id);
              if (imgElem) imgElem.src = ud.profile.profilePic;
            }
          } catch (e) {}
        })();
      }

      // attach delegated event listeners for kebab menu
      setupKebabBehavior();
    }

    // Manage single popup at a time
    let openPopup = null;

    function closeOpenPopup() {
      if (openPopup && openPopup.parentElement) {
        openPopup.remove();
      }
      openPopup = null;
      // reset expanded states for kebab buttons
      document.querySelectorAll('.post-kebab[aria-expanded="true"]').forEach(b => b.setAttribute('aria-expanded','false'));
    }

    function setupKebabBehavior() {
      // click handler (delegation)
      document.getElementById('feed').addEventListener('click', async function (ev) {
        const kebab = ev.target.closest('.post-kebab');
        if (!kebab) return;

        ev.preventDefault();
        ev.stopPropagation();

        const postEl = kebab.closest('.post');
        const postId = postEl && postEl.dataset.postId;
        const owner = postEl && postEl.dataset.postOwner;

        // toggle: if popup already open for this post -> close
        if (openPopup && openPopup.dataset.postId === postId) {
          closeOpenPopup();
          return;
        }
        // close any existing
        closeOpenPopup();

        // create popup
        const popup = document.createElement('div');
        popup.className = 'post-popup';
        popup.dataset.postId = postId;

        // If current user is owner -> show edit & delete. Otherwise show report/profile actions
        const isOwner = (myUsername && owner && myUsername === owner);
        if (isOwner) {
          const editLink = document.createElement('a');
          editLink.href = `/post/${encodeURIComponent(postId)}/edit`;
          editLink.textContent = 'แก้ไขโพสต์';
          popup.appendChild(editLink);

          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.textContent = 'ลบโพสต์';
          delBtn.style.color = '';
          delBtn.addEventListener('click', async function (e) {
            e.preventDefault();
            if (!confirm('ลบโพสต์นี้?')) return;
            try {
              await fetch('/api/post/' + encodeURIComponent(postId), { method: 'DELETE' });
              // remove post element from DOM
              const targetPost = document.querySelector('.post[data-post-id="' + postId + '"]');
              if (targetPost) targetPost.remove();
            } catch (err) {
              alert('เกิดข้อผิดพลาดขณะลบโพสต์');
            } finally {
              closeOpenPopup();
            }
          });
          popup.appendChild(delBtn);
        } else {
          const viewProfile = document.createElement('a');
          viewProfile.href = `/user/${encodeURIComponent(owner)}`;
          viewProfile.textContent = 'ไปยังโปรไฟล์';
          popup.appendChild(viewProfile);

          const reportBtn = document.createElement('button');
          reportBtn.type = 'button';
          reportBtn.textContent = 'รายงานโพสต์';
          reportBtn.addEventListener('click', function () {
            alert('ฟีเจอร์รายงานยังไม่เปิดใช้งาน');
            closeOpenPopup();
          });
          popup.appendChild(reportBtn);
        }

        // append popup into the post element so it positions correctly
        postEl.appendChild(popup);
        openPopup = popup;
        kebab.setAttribute('aria-expanded','true');
      }, true);

      // close popup when clicking outside
      document.addEventListener('click', function (ev) {
        if (!ev.target.closest('.post-popup') && !ev.target.closest('.post-kebab')) {
          closeOpenPopup();
        }
      }, true);

      // also close on Escape
      document.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape') closeOpenPopup();
      });
    }

    // Initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', renderFeed);
    } else {
      setTimeout(renderFeed, 0);
    }
  })();
  </script>
</body>
</html>