<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ดูโพสต์</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      .post { position: relative; padding: 12px; border-radius: 10px; background: linear-gradient(180deg,#fff,#fcfdff); margin-bottom: 12px; border: 1px solid rgba(15,23,42,0.03); }
      .post-header { display:flex; align-items:flex-start; gap:12px; width:100%; margin-bottom:6px; }
      .post-avatar .avatar-img { width:48px; height:48px; border-radius:10px; object-fit: cover; flex-shrink:0; }
      .post-header-meta { display:flex; flex-direction:column; gap:2px; min-width:0; }
      .post-username a { font-weight:700; color:var(--text); text-decoration:none; display:inline-block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:240px; }
      .post-time { color:var(--muted); font-size:0.88rem; }

      .post-body { margin-top: 4px; line-height:1.55; display:flex; flex-direction:column; gap:8px; }
      .post-content { color:#38414b; white-space:pre-wrap; word-break:break-word; }
      .post-img { margin-top:10px; max-width:100%; height:auto; border-radius:8px; display:block; }

      .post-gallery {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        overflow-x: auto;
        overflow-y: hidden;
        align-items: flex-start;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 6px;
        scroll-behavior: smooth;
      }
      .post-gallery .post-img {
        flex: 0 0 auto;
        align-self: flex-start;
        max-height: 420px;
        max-width: calc(100vw - 96px);
        height: auto;
        width: auto;
        object-fit: contain;
        border-radius: 8px;
        display: block;
      }
      .post-gallery.only-one .post-img {
        max-height: 75vh;
        max-width: 100%;
      }

      .post-kebab { background: transparent; border: none; cursor:pointer; width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; margin-left: auto; }
      .post-kebab:focus { outline: 2px solid rgba(47,128,237,0.12); }

      .post-popup { position:absolute; right:8px; top:44px; left: auto; background:var(--surface); border:1px solid rgba(15,23,42,0.06); border-radius:10px; box-shadow:0 10px 30px rgba(16,24,40,0.08); }
      .post-popup a, .post-popup button { display:block; width:100%; padding:10px 12px; text-align:left; border:none; background:transparent; cursor:pointer; font-weight:600; color:var(--text); }
      .post-popup a:hover, .post-popup button:hover { background:#fbfdff; }

      .post-actions { display:none; }

      @media (max-width:800px) {
        .post-header .post-avatar .avatar-img { width:44px; height:44px; }
        .post-header-meta .post-username a { font-size:0.95rem; }
        .post-time { font-size:0.80rem; }
        .post-gallery .post-img { max-height: 260px; max-width: calc(100vw - 56px); }
      }

      /* ---- Comment Section ---- */
      .comment-item {
        background: var(--surface, #fff);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(29,41,56,0.04);
        border: 1px solid rgba(15,23,42,0.04);
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
      }
      .comment-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 6px;
      }
      .comment-avatar .avatar-img {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        object-fit: cover;
      }
      .comment-meta {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }
      .comment-username a {
        font-weight: 700;
        color: var(--text);
        font-size: 0.96rem;
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 32ch;
      }
      .comment-time {
        color: var(--muted);
        font-size: 0.85rem;
        opacity: 0.95;
        white-space: nowrap;
      }
      .comment-body {
        margin-top: 4px;
      }
      .comment-content {
        color: #38414b;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 1rem;
      }
      /* Input bar for comment at bottom */
      .comment-input-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2000;
        background: #fff;
        box-shadow: 0 -2px 12px rgba(29,41,56,0.08);
        padding: 12px 18px;
        display: flex;
        gap: 8px;
        align-items: center;
        border-top: 1px solid rgba(15,23,42,0.07);
      }
      .comment-input-bar textarea {
        flex: 1 1 auto;
        min-height: 38px;
        max-height: 120px;
        border-radius: 8px;
        border: 1px solid rgba(15,23,42,0.06);
        padding: 8px;
        font-size: 1rem;
        resize: none;
      }
      .comment-input-bar button {
        min-width: 80px;
        border-radius: 8px;
        font-weight: 700;
        padding: 10px 14px;
      }
      /* ป้องกัน main ซ้อนกับ input-bar */
      main { padding-bottom: 74px; }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container">
      <div class="card" id="postCard">
        <div id="postBox"></div>
        <hr style="margin:16px 0;">
        <div id="commentBox"></div>
      </div>
    </div>
  </main>
  <!-- input bar สำหรับคอมเมนต์ -->
  <form id="commentForm" class="comment-input-bar hidden">
    <textarea name="content" placeholder="แสดงความคิดเห็น..." required></textarea>
    <button type="submit" class="btn btn-primary">ส่ง</button>
  </form>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
const postId = location.pathname.split('/').pop();
let myUsername = null;
let myProfile = {};
let commentProfileCache = {};

function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }

async function getProfile(username) {
  if (commentProfileCache[username]) return commentProfileCache[username];
  try {
    const r = await fetch('/api/user/' + encodeURIComponent(username));
    const d = await r.json();
    if (d && d.success && d.profile) {
      commentProfileCache[username] = d.profile;
      return d.profile;
    }
  } catch {}
  return { profilePic: '/img/default_profile.png', displayName: username };
}

async function loadPost() {
    const res = await fetch('/api/post/' + encodeURIComponent(postId));
    const data = await res.json();
    if (!data.success) return document.getElementById('postBox').innerText = 'ไม่พบโพสต์';
    const { post, comments, owner, myUsername: apiUsername } = data;
    myUsername = apiUsername;

    // Build DOM using same structure as feed
    const container = document.getElementById('postBox');
    container.innerHTML = '';
    const art = document.createElement('article');
    art.className = 'post';

    // header
    const header = document.createElement('div'); header.className = 'post-header';
    const avatarA = document.createElement('a'); avatarA.className = 'post-avatar'; avatarA.href = '/user/' + encodeURIComponent(post.username || '');
    const avatarImg = document.createElement('img'); avatarImg.className = 'avatar-img'; avatarImg.alt = post.username || '';
    avatarImg.id = `avatar-${post.username}-${post.id}`;
    avatarImg.dataset.username = post.username || '';
    avatarImg.src = '/img/default_profile.png';
    avatarA.appendChild(avatarImg);
    header.appendChild(avatarA);

    const meta = document.createElement('div'); meta.className = 'post-header-meta';
    const nameDiv = document.createElement('div'); nameDiv.className = 'post-username';
    const nameLink = document.createElement('a'); nameLink.href = '/user/' + encodeURIComponent(post.username || ''); nameLink.textContent = post.username || '(ไม่ระบุ)';
    nameDiv.appendChild(nameLink);
    const timeDiv = document.createElement('div'); timeDiv.className = 'post-time small'; timeDiv.textContent = new Date(post.createdAt).toLocaleString();
    meta.appendChild(nameDiv); meta.appendChild(timeDiv);
    header.appendChild(meta);

    // kebab (same as feed)
    const kebab = document.createElement('button');
    kebab.className = 'post-kebab';
    kebab.type = 'button';
    kebab.setAttribute('aria-haspopup','true');
    kebab.setAttribute('aria-expanded','false');
    kebab.title = 'ตัวเลือกโพสต์';
    kebab.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#97a0b3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>`;
    header.appendChild(kebab);

    art.appendChild(header);

    // body
    const body = document.createElement('div'); body.className = 'post-body';
    const contentDiv = document.createElement('div');
    contentDiv.className = 'post-content';
    contentDiv.innerHTML = escapeHtml(post.content || '');
    body.appendChild(contentDiv);

    const imgs = Array.isArray(post.images) ? post.images.slice() : (post.image ? [post.image] : []);
    if (imgs.length === 1) {
      const im = document.createElement('img');
      im.className = 'post-img';
      im.src = imgs[0];
      im.alt = 'post image';
      im.loading = 'lazy';
      body.appendChild(im);
    } else if (imgs.length > 1) {
      const gallery = document.createElement('div');
      gallery.className = 'post-gallery';
      if (imgs.length === 1) gallery.classList.add('only-one');
      for (const src of imgs) {
        const im = document.createElement('img');
        im.className = 'post-img';
        im.src = src;
        im.alt = 'post image';
        im.loading = 'lazy';
        gallery.appendChild(im);
      }
      body.appendChild(gallery);
    }
    const actionsDiv = document.createElement('div'); actionsDiv.className = 'post-actions';
    if (myUsername === post.username) {
      const editA = document.createElement('a'); editA.className = 'btn btn-ghost'; editA.href = '/post/' + post.id + '/edit'; editA.textContent = 'แก้ไข';
      actionsDiv.appendChild(editA);
      const delBtn = document.createElement('button'); delBtn.className = 'btn btn-ghost'; delBtn.id = 'delBtn'; delBtn.type='button'; delBtn.textContent = 'ลบ';
      actionsDiv.appendChild(delBtn);
    }
    body.appendChild(actionsDiv);

    art.appendChild(body);
    container.appendChild(art);

    // load avatar image
    (async () => {
      try {
        const up = await fetch(`/api/user/${encodeURIComponent(post.username)}`);
        const ud = await up.json();
        if (ud && ud.success && ud.profile && ud.profile.profilePic) {
          const imgElem = document.getElementById("avatar-"+post.username+"-"+post.id);
          if (imgElem) imgElem.src = ud.profile.profilePic;
          myProfile = ud.profile;
        }
      } catch(e){}
    })();

    // kebab popup logic
    kebab.addEventListener('click', function(ev) {
      ev.preventDefault();
      ev.stopPropagation();
      const existing = art.querySelector('.post-popup');
      if (existing) { existing.remove(); kebab.setAttribute('aria-expanded','false'); return; }

      const popup = document.createElement('div');
      popup.className = 'post-popup';
      popup.dataset.postId = post.id;
      const isOwner = (myUsername && post.username && myUsername === post.username);

      if (isOwner) {
        const editA = document.createElement('a');
        editA.href = '/post/' + encodeURIComponent(post.id) + '/edit';
        editA.textContent = 'แก้ไขโพสต์';
        popup.appendChild(editA);

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.textContent = 'ลบโพสต์';
        delBtn.addEventListener('click', async function (e) {
          e.preventDefault();
          if (!confirm('ลบโพสต์นี้?')) return;
          try {
            await fetch('/api/post/' + encodeURIComponent(post.id), { method: 'DELETE' });
            location.replace('/');
          } catch (err) {
            alert('เกิดข้อผิดพลาดขณะลบโพสต์');
          }
        });
        popup.appendChild(delBtn);
      } else {
        const profileA = document.createElement('a');
        profileA.href = '/user/' + encodeURIComponent(post.username || '');
        profileA.textContent = 'ไปยังโปรไฟล์';
        popup.appendChild(profileA);

        const reportBtn = document.createElement('button');
        reportBtn.type = 'button';
        reportBtn.textContent = 'รายงานโพสต์';
        reportBtn.addEventListener('click', function () {
          alert('ฟีเจอร์รายงานยังไม่เปิดใช้งาน');
        });
        popup.appendChild(reportBtn);
      }

      art.appendChild(popup);
      kebab.setAttribute('aria-expanded','true');
      setTimeout(() => {
        const onDoc = (ev) => {
          if (!popup.contains(ev.target) && ev.target !== kebab) {
            popup.remove();
            kebab.setAttribute('aria-expanded','false');
            document.removeEventListener('click', onDoc, true);
          }
        };
        document.addEventListener('click', onDoc, true);
      }, 0);
    });

    // render comments (with new structure)
    renderComments(comments);

    // input bar visibility
    const commentForm = document.getElementById('commentForm');
    if (myUsername) {
      commentForm.classList.remove("hidden");
    } else {
      commentForm.classList.add("hidden");
    }
    // delete handler for post if present
    const delBtn = document.getElementById('delBtn');
    if (delBtn) {
      delBtn.onclick = async () => {
        if (confirm('ลบโพสต์?')) {
          await fetch('/api/post/' + encodeURIComponent(postId), { method: 'DELETE' });
          location.replace('/');
        }
      };
    }
}

async function renderComments(comments) {
  const box = document.getElementById('commentBox');
  box.innerHTML = '<h3>คอมเมนต์</h3>';
  if (!comments || comments.length === 0) {
    box.innerHTML += '<i class="small">ยังไม่มีคอมเมนต์</i>';
    return;
  }
  for (const c of comments) {
    const profile = await getProfile(c.username);
    const avatar = profile.profilePic || '/img/default_profile.png';
    const displayName = profile.displayName || c.username;
    const commentEl = document.createElement('div');
    commentEl.className = 'comment-item';
    commentEl.innerHTML = `
      <div class="comment-header">
        <a href="/user/${encodeURIComponent(c.username)}" class="comment-avatar">
          <img src="${avatar}" alt="${c.username}" class="avatar-img">
        </a>
        <div class="comment-meta">
          <div class="comment-username">
            <a href="/user/${encodeURIComponent(c.username)}">${escapeHtml(displayName)}</a>
          </div>
          <div class="comment-time">${new Date(c.createdAt).toLocaleString()}</div>
        </div>
      </div>
      <div class="comment-body">
        <div class="comment-content">${escapeHtml(c.content)}</div>
        ${myUsername === c.username ? `<div class="mt-16"><button class="btn btn-ghost" onclick="deleteComment('${c.id}')">ลบ</button></div>` : ''}
      </div>
    `;
    box.appendChild(commentEl);
  }
}

loadPost();

document.getElementById('commentForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/post/' + encodeURIComponent(postId) + '/comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.fromEntries(fd.entries()))
    });
    const data = await res.json();
    if (data && data.success) {
        e.target.reset();
        loadPost();
    } else {
        alert('ไม่สามารถส่งคอมเมนต์ได้');
    }
};

window.deleteComment = async (cid) => {
    if (confirm('ยืนยันลบคอมเมนต์?')) {
        await fetch(`/api/post/${encodeURIComponent(postId)}/comment/${encodeURIComponent(cid)}`, {method:'DELETE'});
        loadPost();
    }
};
</script>
</body>
</html>