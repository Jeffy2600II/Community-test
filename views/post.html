<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ดูโพสต์</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      /* Single post: use same inline header layout as feed */
      .post-header { display:flex; align-items:flex-start; gap:12px; margin-bottom:8px; }
      .post-header .post-avatar { position: static; display:inline-flex; align-items:center; justify-content:center; }
      .post-header .post-avatar .avatar-img { width:48px; height:48px; border-radius:10px; object-fit:cover; }
      .post-header-meta { display:flex; flex-direction:column; gap:4px; min-width:0; }
      .post .post-body { margin-top: 6px; display:flex; flex-direction:column; gap:8px; }
      .post-content { white-space: pre-wrap; word-break: break-word; color:#38414b; }
      .post-img { max-width:100%; height:auto; border-radius:8px; margin-top:8px; display:block; }

      /* ===== Use horizontal gallery here too (same rules as feed) ===== */
      .post-gallery {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        overflow-x: auto;
        overflow-y: hidden;
        align-items: flex-start;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 6px;
      }
      .post-gallery .post-img {
        flex: 0 0 auto;
        align-self: flex-start;
        max-height: 420px;
        max-width: calc(100vw - 96px);
        height: auto;
        width: auto;
        object-fit: contain;
        border-radius: 8px;
      }

      @media (max-width:800px) {
        .post-header .post-avatar .avatar-img { width:44px; height:44px; }
        .post-header-meta .post-username a { font-size:0.95rem; }
        .post-time { font-size:0.80rem; }
        .post-gallery .post-img { max-height: 260px; max-width: calc(100vw - 56px); }
      }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container">
      <div class="card" id="postCard">
        <div id="postBox"></div>
        <hr style="margin:16px 0;">
        <div id="commentBox"></div>
        <form id="commentForm" class="mt-16 hidden">
          <label class="small">แสดงความคิดเห็น</label>
          <textarea name="content" placeholder="แสดงความคิดเห็น" required></textarea>
          <div class="text-right mt-16">
            <button type="submit" class="btn btn-primary">แสดงความคิดเห็น</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>
<script src="/js/main.js"></script>
<script>
const postId = location.pathname.split('/').pop();
let myUsername;

function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function loadPost() {
    const res = await fetch('/api/post/' + postId);
    const data = await res.json();
    if (!data.success) return document.getElementById('postBox').innerText = 'ไม่พบโพสต์';
    const { post, comments, owner, myUsername: apiUsername } = data;
    myUsername = apiUsername;

    // Build DOM using same structure as feed
    const container = document.getElementById('postBox');
    container.innerHTML = '';
    const art = document.createElement('article');
    art.className = 'post';

    // header
    const header = document.createElement('div'); header.className = 'post-header';
    const avatarA = document.createElement('a'); avatarA.className = 'post-avatar'; avatarA.href = '/user/' + encodeURIComponent(post.username || '');
    const avatarImg = document.createElement('img'); avatarImg.className = 'avatar-img'; avatarImg.alt = post.username || '';
    avatarImg.id = `avatar-${post.username}-${post.id}`;
    avatarImg.src = '/img/default_profile.png';
    avatarA.appendChild(avatarImg);
    header.appendChild(avatarA);

    const meta = document.createElement('div'); meta.className = 'post-header-meta';
    const nameDiv = document.createElement('div'); nameDiv.className = 'post-username';
    const nameLink = document.createElement('a'); nameLink.href = '/user/' + encodeURIComponent(post.username || ''); nameLink.textContent = post.username || '(ไม่ระบุ)';
    nameDiv.appendChild(nameLink);
    const timeDiv = document.createElement('div'); timeDiv.className = 'post-time small'; timeDiv.textContent = new Date(post.createdAt).toLocaleString();
    meta.appendChild(nameDiv); meta.appendChild(timeDiv);
    header.appendChild(meta);

    art.appendChild(header);

    // body
    const body = document.createElement('div'); body.className = 'post-body';

    // images: support post.images (array) or legacy post.image
    const imgs = Array.isArray(post.images) ? post.images.slice() : (post.image ? [post.image] : []);
    if (imgs.length === 1) {
      const im = document.createElement('img');
      im.className = 'post-img';
      im.src = imgs[0];
      im.alt = 'post image';
      im.loading = 'lazy';
      body.appendChild(im);
    } else if (imgs.length > 1) {
      const gallery = document.createElement('div');
      gallery.className = 'post-gallery';
      for (const src of imgs) {
        const im = document.createElement('img');
        im.className = 'post-img';
        im.src = src;
        im.alt = 'post image';
        im.loading = 'lazy';
        gallery.appendChild(im);
      }
      body.appendChild(gallery);
    }

    const contentDiv = document.createElement('div');
    contentDiv.className = 'post-content mt-8';
    contentDiv.innerHTML = escapeHtml(post.content || '');
    body.appendChild(contentDiv);

    const actionsDiv = document.createElement('div'); actionsDiv.className = 'post-actions mt-16';
    if (myUsername === post.username) {
      const editA = document.createElement('a'); editA.className = 'btn btn-ghost'; editA.href = '/post/' + post.id + '/edit'; editA.textContent = 'แก้ไข';
      actionsDiv.appendChild(editA);
      const delBtn = document.createElement('button'); delBtn.className = 'btn btn-ghost'; delBtn.id = 'delBtn'; delBtn.type='button'; delBtn.textContent = 'ลบ';
      actionsDiv.appendChild(delBtn);
    }
    body.appendChild(actionsDiv);

    art.appendChild(body);
    container.appendChild(art);

    // tải avatar (เหมือน feed)
    (async () => {
      try {
        const up = await fetch(`/api/user/${encodeURIComponent(post.username)}`);
        const ud = await up.json();
        if (ud && ud.success && ud.profile && ud.profile.profilePic) {
          const imgElem = document.getElementById("avatar-"+post.username+"-"+post.id);
          if (imgElem) imgElem.src = ud.profile.profilePic;
        }
      } catch(e){}
    })();

    if (myUsername === post.username) {
        const del = document.getElementById('delBtn');
        if (del) del.onclick = async () => {
            if (confirm('ลบโพสต์?')) {
                await fetch('/api/post/' + postId, { method: 'DELETE' });
                location.replace('/');
            }
        };
    }

    // render comments
    let cHtml = '<h3>คอมเมนต์</h3>';
    if (!comments || comments.length === 0) cHtml += '<i class="small">ยังไม่มีคอมเมนต์</i>';
    for (let c of comments) {
        cHtml += `<div class="comment">
            <div class="meta"><strong><a href="/user/${c.username}">${c.username}</a></strong> • ${new Date(c.createdAt).toLocaleString()}</div>
            <div>${escapeHtml(c.content)}</div>
            ${myUsername === c.username ? `<div class="mt-16"><button class="btn btn-ghost" onclick="deleteComment('${c.id}')">ลบ</button></div>` : ''}
        </div>`;
    }
    document.getElementById('commentBox').innerHTML = cHtml;
    if (myUsername) document.getElementById('commentForm').classList.remove("hidden");
}
loadPost();

document.getElementById('commentForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/post/' + postId + '/comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.fromEntries(fd.entries()))
    });
    const data = await res.json();
    if (data.success) {
        e.target.reset();
        loadPost();
    }
};
window.deleteComment = async (cid) => {
    if (confirm('ยืนยันลบคอมเมนต์?')) {
        await fetch(`/api/post/${postId}/comment/${cid}`, {method:'DELETE'});
        loadPost();
    }
};
</script>
</body>
</html>