<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <title>ดูโพสต์</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container">
      <div class="card" id="postCard">
        <div id="postBox"></div>
        <hr class="divider">
        <div id="commentBox"></div>

        <form id="commentForm" class="hidden mt-12">
          <label class="small">แสดงความคิดเห็น</label>
          <textarea name="content" placeholder="แสดงความคิดเห็น" required></textarea>
          <div class="row" style="justify-content:flex-end;margin-top:8px;">
            <button type="submit" class="btn btn-primary">แสดงความคิดเห็น</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>
<script src="/js/main.js"></script>
<script>
const postId = location.pathname.split('/').pop();
let myUsername;

async function loadPost() {
    const res = await fetch('/api/post/' + postId);
    const data = await res.json();
    if (!data.success) return document.getElementById('postBox').innerText = 'ไม่พบโพสต์';
    const { post, comments, owner, myUsername: apiUsername } = data;
    myUsername = apiUsername;
    let html = `<header class="post-header">
      <div>
        <h2 style="margin:0 0 6px 0">${post.title}</h2>
        <div class="small">โดย <a href="/user/${post.username}">${post.username}</a> • ${new Date(post.createdAt).toLocaleString()}</div>
      </div>
      <div style="display:flex;gap:8px;">
        ${myUsername === post.username ? `<a class="btn btn-ghost" href="/post/${post.id}/edit">แก้ไข</a> <button class="btn btn-ghost" id="delBtn">ลบ</button>` : ''}
      </div>
    </header>
    ${post.image ? `<img src="${post.image}" class="post-img" alt="post image" loading="lazy">` : ''}
    <div style="margin-top:12px">${post.content}</div>`;
    document.getElementById('postBox').innerHTML = html;

    if (myUsername === post.username) {
        const del = document.getElementById('delBtn');
        if (del) del.onclick = async () => {
            if (confirm('ลบโพสต์?')) {
                await fetch('/api/post/' + postId, { method: 'DELETE' });
                location.replace('/');
            }
        };
    }

    // render comments
    let cHtml = '<h3>คอมเมนต์</h3>';
    if (!comments || comments.length === 0) cHtml += '<i class="small">ยังไม่มีคอมเมนต์</i>';
    for (let c of comments) {
        cHtml += `<div class="comment">
            <div class="meta"><strong><a href="/user/${c.username}">${c.username}</a></strong> • ${new Date(c.createdAt).toLocaleString()}</div>
            <div>${c.content}</div>
            ${myUsername === c.username ? `<div class="mt-8"><button class="btn btn-ghost" onclick="deleteComment('${c.id}')">ลบ</button></div>` : ''}
        </div>`;
    }
    document.getElementById('commentBox').innerHTML = cHtml;
    if (myUsername) document.getElementById('commentForm').classList.remove('hidden');
}
loadPost();

document.getElementById('commentForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/post/' + postId + '/comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.fromEntries(fd.entries()))
    });
    const data = await res.json();
    if (data.success) {
        e.target.reset();
        loadPost();
    }
};
window.deleteComment = async (cid) => {
    if (confirm('ยืนยันลบคอมเมนต์?')) {
        await fetch(`/api/post/${postId}/comment/${cid}`, {method:'DELETE'});
        loadPost();
    }
};
</script>
</body>
</html>