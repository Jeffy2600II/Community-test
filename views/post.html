<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ดูโพสต์</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      /* Make single-post layout match feed/index.html 100% for post structure and gallery behavior.
         All post-related classes (.post, .post-header, .post-body, .post-gallery, .post-img, etc.)
         mirror the feed page so visuals/interaction are identical. */

      .post { position: relative; padding: 12px; border-radius: 10px; background: linear-gradient(180deg,#fff,#fcfdff); margin-bottom: 12px; border: 1px solid rgba(15,23,42,0.03); }
      .post-header { display:flex; align-items:flex-start; gap:12px; width:100%; margin-bottom:6px; }
      .post-avatar .avatar-img { width:48px; height:48px; border-radius:10px; object-fit: cover; flex-shrink:0; }
      .post-header-meta { display:flex; flex-direction:column; gap:2px; min-width:0; }
      .post-username a { font-weight:700; color:var(--text); text-decoration:none; display:inline-block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:240px; }
      .post-time { color:var(--muted); font-size:0.88rem; }

      .post-body { margin-top: 4px; line-height:1.55; display:flex; flex-direction:column; gap:8px; }
      .post-content { color:#38414b; white-space:pre-wrap; word-break:break-word; }
      .post-img { margin-top:10px; max-width:100%; height:auto; border-radius:8px; display:block; }

      /* Horizontal scrolling gallery — identical rules to index.html */
      .post-gallery {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        overflow-x: auto;
        overflow-y: hidden;
        align-items: flex-start;         /* anchor all images to the top */
        -webkit-overflow-scrolling: touch;
        padding-bottom: 6px;             /* breathing room for horizontal scroll */
        scroll-behavior: smooth;
      }
      .post-gallery .post-img {
        flex: 0 0 auto;                  /* do not shrink/grow, keep intrinsic sizing within limits */
        align-self: flex-start;          /* ensure each image is aligned to top of the gallery row */
        max-height: 420px;               /* max height for images in the gallery */
        max-width: calc(100vw - 96px);   /* ensure very wide images scale down to fit viewport when viewed */
        height: auto;
        width: auto;
        object-fit: contain;             /* avoid cropping; preserve full image within the max box */
        border-radius: 8px;
        display: block;
      }
      .post-gallery.only-one .post-img {
        max-height: 75vh;
        max-width: 100%;
      }

      /* Comment styles: structure mirrors post but compact */
      .comment {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        padding: 10px;
        border-radius: 10px;
        background: #fbfdff;
        border: 1px solid rgba(15,23,42,0.03);
      }
      .comment .comment-avatar {
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
      }
      .comment .comment-avatar img {
        width:40px;
        height:40px;
        border-radius:8px;
        object-fit: cover;
        border: 1px solid rgba(15,23,42,0.06);
      }
      .comment .comment-body {
        display:flex;
        flex-direction: column;
        gap:6px;
        min-width: 0;
      }
      .comment .comment-meta {
        display:flex;
        gap:8px;
        align-items:center;
      }
      .comment .comment-username a {
        font-weight:700;
        color:var(--text);
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        max-width: 40ch;
      }
      .comment .comment-time {
        color: var(--muted);
        font-size: 0.85rem;
      }
      .comment .comment-content {
        color:#38414b;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 0.95rem;
      }

      /* fixed comment input at bottom */
      #commentForm.fixed {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.98);
        border-top: 1px solid rgba(15,23,42,0.04);
        padding: 10px 12px;
        box-shadow: 0 -8px 24px rgba(16,24,40,0.06);
        z-index: 1400;
        display: flex;
        justify-content: center;
      }
      #commentForm.fixed .comment-input-inner {
        width: min(920px, calc(100% - 32px));
        display:flex;
        gap:8px;
        align-items:flex-end;
      }
      #commentForm.fixed textarea[name="content"] {
        flex: 1;
        min-height: 44px;
        max-height: 160px;
        resize: vertical;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(15,23,42,0.06);
        font-size: 0.95rem;
      }
      #commentForm.fixed button[type="submit"] {
        min-width: 96px;
      }

      /* ensure main content isn't hidden behind fixed input */
      main { padding-bottom: 110px; }

      @media (max-width:800px) {
        .post-header .post-avatar .avatar-img { width:44px; height:44px; }
        .post-header-meta .post-username a { font-size:0.95rem; }
        .post-time { font-size:0.80rem; }
        .post-gallery .post-img { max-height: 260px; max-width: calc(100vw - 56px); }
        #commentForm.fixed .comment-input-inner { width: calc(100% - 24px); }
      }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container">
      <div class="card" id="postCard">
        <div id="postBox"></div>
        <hr style="margin:16px 0;">
        <div id="commentBox"></div>

        <!-- keep this form in DOM but we'll fix it to bottom via JS/CSS -->
        <form id="commentForm" class="mt-16 hidden" aria-label="ฟอร์มแสดงความคิดเห็น">
          <div class="comment-input-inner">
            <textarea name="content" placeholder="เขียนความคิดเห็น..." required aria-label="ข้อความความคิดเห็น"></textarea>
            <button type="submit" class="btn btn-primary">ส่ง</button>
          </div>
        </form>

      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
/*
  Render single post with comments whose structure matches posts (avatar, name, time, content).
  Comment input is fixed to bottom. Avatar loading reused from feed logic.
*/
const postId = location.pathname.split('/').pop();
let myUsername;

function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function loadPost() {
    const res = await fetch('/api/post/' + encodeURIComponent(postId));
    const data = await res.json();
    if (!data.success) {
      document.getElementById('postBox').innerText = 'ไม่พบโพสต์';
      return;
    }
    const { post, comments, owner, myUsername: apiUsername } = data;
    myUsername = apiUsername;

    renderPost(post);
    renderComments(comments || []);
    setupCommentForm();
    // load avatar for post and comment authors
    loadAvatars();
}

function renderPost(post) {
    const container = document.getElementById('postBox');
    container.innerHTML = '';
    const art = document.createElement('article');
    art.className = 'post';

    // header
    const header = document.createElement('div'); header.className = 'post-header';
    const avatarA = document.createElement('a'); avatarA.className = 'post-avatar'; avatarA.href = '/user/' + encodeURIComponent(post.username || '');
    const avatarImg = document.createElement('img'); avatarImg.className = 'avatar-img'; avatarImg.alt = post.username || '';
    avatarImg.id = `avatar-${post.username}-${post.id}`;
    avatarImg.dataset.username = post.username || '';
    avatarImg.src = '/img/default_profile.png';
    avatarA.appendChild(avatarImg);
    header.appendChild(avatarA);

    const meta = document.createElement('div'); meta.className = 'post-header-meta';
    const nameDiv = document.createElement('div'); nameDiv.className = 'post-username';
    const nameLink = document.createElement('a'); nameLink.href = '/user/' + encodeURIComponent(post.username || ''); nameLink.textContent = post.username || '(ไม่ระบุ)';
    nameDiv.appendChild(nameLink);
    const timeDiv = document.createElement('div'); timeDiv.className = 'post-time small'; timeDiv.textContent = new Date(post.createdAt).toLocaleString();
    meta.appendChild(nameDiv); meta.appendChild(timeDiv);
    header.appendChild(meta);

    // kebab (same as feed)
    const kebab = document.createElement('button');
    kebab.className = 'post-kebab';
    kebab.type = 'button';
    kebab.setAttribute('aria-haspopup','true');
    kebab.setAttribute('aria-expanded','false');
    kebab.title = 'ตัวเลือกโพสต์';
    kebab.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#97a0b3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>`;
    header.appendChild(kebab);

    art.appendChild(header);

    // body (content first, then images)
    const body = document.createElement('div'); body.className = 'post-body';

    const contentDiv = document.createElement('div');
    contentDiv.className = 'post-content';
    contentDiv.innerHTML = escapeHtml(post.content || '');
    body.appendChild(contentDiv);

    const imgs = Array.isArray(post.images) ? post.images.slice() : (post.image ? [post.image] : []);
    if (imgs.length === 1) {
      const im = document.createElement('img');
      im.className = 'post-img';
      im.src = imgs[0];
      im.alt = 'post image';
      im.loading = 'lazy';
      body.appendChild(im);
    } else if (imgs.length > 1) {
      const gallery = document.createElement('div');
      gallery.className = 'post-gallery';
      if (imgs.length === 1) gallery.classList.add('only-one');
      for (const src of imgs) {
        const im = document.createElement('img');
        im.className = 'post-img';
        im.src = src;
        im.alt = 'post image';
        im.loading = 'lazy';
        gallery.appendChild(im);
      }
      body.appendChild(gallery);
    }

    const actionsDiv = document.createElement('div'); actionsDiv.className = 'post-actions';
    if (myUsername === post.username) {
      const editA = document.createElement('a'); editA.className = 'btn btn-ghost'; editA.href = '/post/' + post.id + '/edit'; editA.textContent = 'แก้ไข';
      actionsDiv.appendChild(editA);
      const delBtn = document.createElement('button'); delBtn.className = 'btn btn-ghost'; delBtn.id = 'delBtn'; delBtn.type='button'; delBtn.textContent = 'ลบ';
      actionsDiv.appendChild(delBtn);
    }
    body.appendChild(actionsDiv);

    art.appendChild(body);
    container.appendChild(art);

    // delete handler if present
    const delBtn = document.getElementById('delBtn');
    if (delBtn) {
      delBtn.onclick = async () => {
        if (confirm('ลบโพสต์?')) {
          await fetch('/api/post/' + encodeURIComponent(postId), { method: 'DELETE' });
          location.replace('/');
        }
      };
    }

    // kebab popup logic (same behavior as feed)
    kebab.addEventListener('click', function(ev) {
      ev.preventDefault();
      ev.stopPropagation();
      const existing = art.querySelector('.post-popup');
      if (existing) { existing.remove(); kebab.setAttribute('aria-expanded','false'); return; }

      const popup = document.createElement('div');
      popup.className = 'post-popup';
      popup.dataset.postId = post.id;

      const isOwner = (myUsername && post.username && myUsername === post.username);

      if (isOwner) {
        const editA = document.createElement('a');
        editA.href = '/post/' + encodeURIComponent(post.id) + '/edit';
        editA.textContent = 'แก้ไขโพสต์';
        popup.appendChild(editA);

        const delBtn2 = document.createElement('button');
        delBtn2.type = 'button';
        delBtn2.textContent = 'ลบโพสต์';
        delBtn2.addEventListener('click', async function (e) {
          e.preventDefault();
          if (!confirm('ลบโพสต์นี้?')) return;
          try {
            await fetch('/api/post/' + encodeURIComponent(post.id), { method: 'DELETE' });
            location.replace('/');
          } catch (err) {
            alert('เกิดข้อผิดพลาดขณะลบโพสต์');
          }
        });
        popup.appendChild(delBtn2);
      } else {
        const profileA = document.createElement('a');
        profileA.href = '/user/' + encodeURIComponent(post.username || '');
        profileA.textContent = 'ไปยังโปรไฟล์';
        popup.appendChild(profileA);

        const reportBtn = document.createElement('button');
        reportBtn.type = 'button';
        reportBtn.textContent = 'รายงานโพสต์';
        reportBtn.addEventListener('click', function () {
          alert('ฟีเจอร์รายงานยังไม่เปิดใช้งาน');
        });
        popup.appendChild(reportBtn);
      }

      art.appendChild(popup);
      kebab.setAttribute('aria-expanded','true');
      // close popup on outside click
      setTimeout(() => {
        const onDoc = (ev) => {
          if (!popup.contains(ev.target) && ev.target !== kebab) {
            popup.remove();
            kebab.setAttribute('aria-expanded','false');
            document.removeEventListener('click', onDoc, true);
          }
        };
        document.addEventListener('click', onDoc, true);
      }, 0);
    });
}

function renderComments(comments) {
    const box = document.getElementById('commentBox');
    box.innerHTML = '';
    if (!comments || comments.length === 0) {
      box.innerHTML = '<i class="small">ยังไม่มีคอมเมนต์</i>';
      return;
    }

    for (const c of comments) {
      const row = document.createElement('div');
      row.className = 'comment';
      row.id = 'comment-' + c.id;

      // avatar
      const avatarLink = document.createElement('a');
      avatarLink.className = 'comment-avatar';
      avatarLink.href = '/user/' + encodeURIComponent(c.username || '');
      const img = document.createElement('img');
      img.alt = c.username || '';
      img.dataset.username = c.username || '';
      img.src = '/img/default_profile.png';
      avatarLink.appendChild(img);
      row.appendChild(avatarLink);

      // body
      const body = document.createElement('div');
      body.className = 'comment-body';

      const meta = document.createElement('div');
      meta.className = 'comment-meta';
      const uname = document.createElement('div');
      uname.className = 'comment-username';
      const unameA = document.createElement('a');
      unameA.href = '/user/' + encodeURIComponent(c.username || '');
      unameA.textContent = c.username || '(ไม่ระบุ)';
      uname.appendChild(unameA);

      const time = document.createElement('div');
      time.className = 'comment-time small';
      time.textContent = new Date(c.createdAt).toLocaleString();

      meta.appendChild(uname);
      meta.appendChild(time);

      const content = document.createElement('div');
      content.className = 'comment-content';
      content.textContent = c.content || '';

      body.appendChild(meta);
      body.appendChild(content);

      row.appendChild(body);
      box.appendChild(row);
    }

    // after DOM created, load avatars for comment authors
    loadAvatarsForComments();
}

async function loadAvatars() {
  // load post avatar(s) already added in renderPost by id
  // also run avatar loader for comment images
  loadAvatarsForComments();

  // ensure post avatar loading for its username (if any)
  const postAvatarImg = document.querySelector('#postBox img.avatar-img[data-username]');
  if (postAvatarImg && postAvatarImg.dataset.username) {
    const username = postAvatarImg.dataset.username;
    try {
      const up = await fetch('/api/user/' + encodeURIComponent(username));
      if (!up.ok) return;
      const ud = await up.json();
      if (ud && ud.success && ud.profile && ud.profile.profilePic) {
        postAvatarImg.src = ud.profile.profilePic;
      }
    } catch(e){}
  }
}

async function loadAvatarsForComments() {
  const imgs = Array.from(document.querySelectorAll('#commentBox img[data-username]'));
  const unique = Array.from(new Set(imgs.map(i => i.dataset.username).filter(Boolean)));
  for (const username of unique) {
    (async () => {
      try {
        const up = await fetch('/api/user/' + encodeURIComponent(username));
        if (!up.ok) return;
        const ud = await up.json();
        if (!ud || !ud.success || !ud.profile) return;
        const pic = ud.profile.profilePic;
        if (!pic) return;
        document.querySelectorAll('#commentBox img[data-username="' + CSS.escape(username) + '"]').forEach(i => {
          i.addEventListener('error', function onErr() {
            i.removeEventListener('error', onErr);
            i.src = '/img/default_profile.png';
          }, { once: true });
          i.src = pic;
        });
      } catch (e) { /* ignore */ }
    })();
  }
}

function setupCommentForm() {
  const form = document.getElementById('commentForm');
  // show only if logged in
  if (myUsername) {
    form.classList.remove('hidden');
    form.classList.add('fixed');
  } else {
    form.classList.add('hidden');
    form.classList.remove('fixed');
  }

  form.onsubmit = async function (e) {
    e.preventDefault();
    const fd = new FormData(form);
    const body = Object.fromEntries(fd.entries());
    try {
      const res = await fetch('/api/post/' + encodeURIComponent(postId) + '/comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data && data.success) {
        form.reset();
        // reload comments by reloading post data
        await loadPost();
        // focus textarea for further comments
        const ta = form.querySelector('textarea[name="content"]');
        if (ta) ta.focus();
      } else {
        alert((data && data.msg) ? data.msg : 'ไม่สามารถส่งคอมเมนต์ได้');
      }
    } catch (err) {
      alert('เกิดข้อผิดพลาดเครือข่าย');
    }
  };
}

// initial load
loadPost();
</script>
</body>
</html>