<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <title>โปรไฟล์ของฉัน</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      .profile-switch-view {
        display: flex;
        gap: 10px;
        margin: 12px 0 0 0;
        justify-content: center;
      }
      .profile-switch-view .btn {
        min-width: 110px;
      }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container">
      <div class="grid-2">
        <aside class="profile-hero card" id="hero">
          <img id="heroPic" src="/img/default_profile.png" alt="profile" class="profile-hero avatar">
          <div style="text-align:center;">
            <div id="displayName" style="font-size:1.2rem;font-weight:700"></div>
            <div id="usernameLine" class="small" style="margin-top:4px"></div>
          </div>
          <div class="actions" style="margin-top:8px;">
            <a href="/profile/edit"><button class="btn btn-primary">แก้ไขโปรไฟล์</button></a>
            <a href="/post/create"><button class="btn btn-ghost">สร้างโพสต์</button></a>
          </div>
          <div class="profile-switch-view" id="profileSwitchView" style="display:none;">
            <!-- ปุ่มจะถูกเติมด้วย JS -->
          </div>
          <div class="small" id="counts" style="margin-top:8px"></div>
        </aside>

        <section class="profile-main">
          <div class="card" id="aboutArea"></div>
          <div class="card" id="myPosts" style="margin-top:12px"></div>
        </section>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
(async ()=>{
    // โหลดข้อมูลโปรไฟล์ตัวเอง
    const pr = await fetch('/api/profile');
    if (!pr.ok) { location.href = '/login'; return; }
    const data = await pr.json();
    if (!data.success) { document.getElementById('aboutArea').innerText = 'ไม่สามารถโหลดโปรไฟล์'; return; }
    const { profile, followersCount, followingCount } = data;

    document.getElementById('heroPic').src = profile.profilePic || '/img/default_profile.png';
    document.getElementById('displayName').innerText = profile.displayName || profile.username;
    document.getElementById('usernameLine').innerText = '@' + profile.username;
    document.getElementById('counts').innerHTML = `ติดตาม: ${followingCount} • ผู้ติดตาม: ${followersCount}`;

    // ปุ่มสลับดูโปรไฟล์ส่วนตัว/สาธารณะ
    const switchView = document.getElementById('profileSwitchView');
    if (switchView) {
      // แสดงปุ่มเสมอในหน้า profile (ดู public กับดูส่วนตัว)
      switchView.style.display = 'flex';
      switchView.innerHTML = `
        <a href="/user/${encodeURIComponent(profile.username)}" class="btn btn-ghost">ดูโปรไฟล์แบบสาธารณะ</a>
        <a href="/profile" class="btn btn-muted">ดูโปรไฟล์แบบเจ้าของ</a>
      `;
    }

    // about
    let aboutHtml = `<h3>เกี่ยวกับ</h3>
      <div class="small" style="margin-top:8px">${profile.bio ? profile.bio : '<i>ยังไม่มีข้อมูล</i>'}</div>
      <div class="small" style="margin-top:10px">เข้าร่วมเมื่อ: ${new Date(profile.createdAt).toLocaleDateString()}</div>
      <div style="margin-top:8px" class="small"><strong>อีเมล:</strong> ${profile.showEmail ? (profile.email || '<i>ไม่มี</i>') : '<i>ซ่อน</i>'}</div>`;
    document.getElementById('aboutArea').innerHTML = aboutHtml;

    // posts
    const pr2 = await fetch('/api/user/' + encodeURIComponent(profile.username) + '/posts');
    if (pr2.ok) {
      const postsData = await pr2.json();
      const posts = postsData.posts || [];
      let postlist = '<div class="section-title"><span>โพสต์ของฉัน</span></div>';
      postlist += posts.length ? posts.map(p=>`<div class="post" style="padding:10px 12px;margin-bottom:8px;"><div style="flex:1"><h4 style="margin:0"><a href="/post/${p.id}">${p.title}</a></h4><div class="small" style="color:#888">${new Date(p.createdAt).toLocaleString()}</div></div></div>`).join('') : '<div class="small" style="padding:14px 0;">ยังไม่มีโพสต์</div>';
      document.getElementById('myPosts').innerHTML = postlist;
    }
})();
</script>
</body>
</html>