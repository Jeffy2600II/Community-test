<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>โปรไฟล์สมาชิก</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      /* Minimal page-scoped adjustments to improve mobile layout without changing structure */
      /* Keep these rules small and specific so they don't interfere with global stylesheet */
      .profile-hero {
        align-items: center;
      }
      .profile-hero .avatar {
        width: 140px;
        height: 140px;
        border-radius: 18px;
        object-fit: cover;
      }
      #followArea button {
        min-width: 120px;
      }
      /* Make follow button stack nicely on narrow screens and full-width for better touch targets */
      @media (max-width: 800px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
        .profile-hero {
          padding: 16px;
          gap: 12px;
        }
        .profile-hero .avatar {
          width: 120px;
          height: 120px;
        }
        .profile-hero .row {
          flex-direction: column;
          gap: 8px;
        }
        #followArea {
          width: 100%;
          display: flex;
          justify-content: center;
        }
        #followArea button {
          width: 100%;
          max-width: 360px;
        }
        .profile-main {
          padding-top: 0;
        }
        /* ensure about & posts have comfortable spacing on small screens */
        #aboutArea, #userPosts {
          padding-left: 8px;
          padding-right: 8px;
        }
      }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container">
      <div class="grid-2">
        <aside class="profile-hero card" id="hero">
          <img id="heroPic" src="/img/default_profile.png" alt="profile" class="profile-hero avatar" loading="lazy">
          <div style="text-align:center;">
            <div id="displayName" style="font-size:1.2rem;font-weight:700"></div>
            <div id="usernameLine" class="small mt-8"></div>
          </div>
          <div id="followArea" class="mt-8" aria-live="polite"></div>
          <div class="small mt-8" id="counts"></div>
        </aside>

        <section class="profile-main">
          <div class="card" id="aboutArea"></div>
          <div class="card" id="userPosts" style="margin-top:12px"></div>
        </section>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
const username = decodeURIComponent(location.pathname.split('/')[2]);

async function renderProfile() {
    const pr = await fetch('/api/user/' + encodeURIComponent(username));
    const resp = await pr.json();
    if(!resp.success) return document.getElementById('aboutArea').innerHTML = '<b>ไม่พบผู้ใช้</b>';
    const { profile, followersCount, followingCount, isFollowing, myUsername } = resp;

    document.getElementById('heroPic').src = profile.profilePic || '/img/default_profile.png';
    document.getElementById('displayName').innerText = profile.displayName || profile.username;
    document.getElementById('usernameLine').innerText = '@' + profile.username;
    document.getElementById('counts').innerHTML = `ติดตาม: ${followingCount} • ผู้ติดตาม: ${followersCount}`;

    const followArea = document.getElementById('followArea');
    followArea.innerHTML = '';
    if (myUsername && myUsername !== profile.username) {
      const btn = document.createElement('button');
      // ใช้คำไทยเพื่อความสอดคล้องกับ UI อื่น ๆ
      btn.className = 'btn ' + (isFollowing ? 'btn-ghost' : 'btn-primary');
      btn.innerText = isFollowing ? 'เลิกติดตาม' : 'ติดตาม';
      btn.setAttribute('aria-label', isFollowing ? 'เลิกติดตามผู้ใช้' : 'ติดตามผู้ใช้');
      btn.onclick = async () => {
        const url = isFollowing ? `/api/user/${encodeURIComponent(profile.username)}/unfollow` : `/api/user/${encodeURIComponent(profile.username)}/follow`;
        const r = await fetch(url, { method: 'POST' });
        const d = await r.json();
        if (d && d.success) {
          await renderProfile(); // reload
        } else alert(d.msg || 'ไม่สำเร็จ');
      };
      followArea.appendChild(btn);
    }

    // About area
    let aboutHtml = `<h3>เกี่ยวกับ</h3>
      <div class="small mt-8">${profile.bio ? profile.bio : '<i>ยังไม่มีข้อมูล</i>'}</div>
      <div class="small mt-10">เข้าร่วมเมื่อ: ${new Date(profile.createdAt).toLocaleDateString()}</div>
      <div class="small mt-8"><strong>อีเมล:</strong> ${profile.showEmail ? (profile.email || '<i>ไม่มี</i>') : '<i>ซ่อน</i>'}</div>`;
    document.getElementById('aboutArea').innerHTML = aboutHtml;

    // posts
    const pr2 = await fetch('/api/user/' + encodeURIComponent(username) + '/posts');
    if (pr2.ok) {
      const postsData = await pr2.json();
      const posts = postsData.posts || [];
      let postlist = '<div class="section-title"><span>โพสต์ของสมาชิกนี้</span></div>';
      if (!posts || posts.length === 0) {
        postlist += '<i class="small">ยังไม่มีโพสต์</i>';
      } else {
        for (const p of posts) {
          const excerpt = (p.content || '').slice(0,220) + ((p.content||'').length > 220 ? '...' : '');
          postlist += `<div class="post" style="padding:10px 12px;margin-bottom:8px;"><div style="flex:1"><h4 style="margin:0"><a href="/post/${p.id}">${excerpt}</a></h4><div class="small">${new Date(p.createdAt).toLocaleString()}</div></div></div>`;
        }
      }
      document.getElementById('userPosts').innerHTML = postlist;
    }
}

renderProfile();
</script>
</body>
</html>