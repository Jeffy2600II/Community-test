<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>โปรไฟล์สมาชิก</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      /* Page-specific responsive tweaks for user profile */
      .profile-hero {
        padding-top: 18px;
        padding-bottom: 18px;
      }
      #heroPic {
        width: 140px;
        height: 140px;
        border-radius: 18px;
        object-fit: cover;
        display: block;
      }
      #followArea .btn {
        min-width: 160px;
      }
      /* Make follow / action buttons stack on small screens and be full width */
      @media (max-width: 800px) {
        .grid-2 { grid-template-columns: 1fr; }
        .profile-hero { align-items: center; padding: 18px; }
        #heroPic { width: 120px; height: 120px; }
        .profile-hero .row { flex-direction: column; gap: 10px; }
        .profile-hero .row .btn { width: 100%; }
        #counts { text-align: center; }
        .profile-main { margin-top: 12px; }
        .card#aboutArea, .card#userPosts { padding: 12px; }
        /* Better spacing for small avatars in lists */
        .post { padding: 12px; gap: 12px; }
      }
      /* Minor polish on desktop */
      @media (min-width: 801px) {
        #followArea .btn { min-width: 130px; }
      }

      /* Ensure long texts don't overflow */
      .profile-hero div { word-break: break-word; }
    </style>
</head>
<body>
  <div id="headerSlot"></div>
  <main>
    <div class="container">
      <div class="grid-2">
        <aside class="profile-hero card" id="hero" aria-labelledby="profileHeading">
          <img id="heroPic" src="/img/default_profile.png" alt="รูปโปรไฟล์" class="profile-hero avatar">
          <div class="text-center" style="width:100%;">
            <div id="displayName" style="font-size:1.2rem;font-weight:700" id="profileHeading"></div>
            <div id="usernameLine" class="small mt-8"></div>
          </div>

          <div class="row mt-12" style="justify-content:center; width:100%;">
            <a id="editProfileBtn" href="/profile/edit" class="btn btn-primary">แก้ไขโปรไฟล์</a>
            <a id="createPostBtn" href="/post/create" class="btn btn-ghost">สร้างโพสต์</a>
          </div>

          <div class="text-center mt-12" style="width:100%;">
            <button id="btnViewPublic" class="btn btn-secondary" type="button" aria-label="ดูโปรไฟล์สาธารณะ">ดูโปรไฟล์สาธารณะ</button>
          </div>

          <div class="small mt-12" id="counts" aria-live="polite"></div>
        </aside>

        <section class="profile-main">
          <div class="card" id="aboutArea" aria-live="polite"></div>
          <div class="card mt-16" id="userPosts" aria-live="polite"></div>
        </section>
      </div>
    </div>
  </main>
  <div id="footerSlot"></div>

<script src="/js/main.js"></script>
<script>
/*
  Responsive user profile page script.
  - loads public user profile data and posts.
  - ensures buttons and links encode the username safely.
*/
const username = decodeURIComponent(location.pathname.split('/')[2] || '');

async function renderProfile() {
  try {
    const pr = await fetch('/api/user/' + encodeURIComponent(username));
    const resp = await pr.json();
    if(!resp || !resp.success) {
      document.getElementById('aboutArea').innerHTML = '<b>ไม่พบผู้ใช้</b>';
      document.getElementById('userPosts').innerHTML = '';
      return;
    }
    const { profile, followersCount = 0, followingCount = 0, isFollowing = false, myUsername } = resp;

    document.getElementById('heroPic').src = profile.profilePic || '/img/default_profile.png';
    document.getElementById('displayName').innerText = profile.displayName || profile.username;
    document.getElementById('usernameLine').innerText = '@' + profile.username;
    document.getElementById('counts').innerHTML = `ติดตาม: ${followingCount} • ผู้ติดตาม: ${followersCount}`;

    const followArea = document.getElementById('followArea');
    if (followArea) followArea.innerHTML = '';

    // About area
    let aboutHtml = `<h3>เกี่ยวกับ</h3>
      <div class="small mt-8">${profile.bio ? escapeHtml(profile.bio) : '<i>ยังไม่มีข้อมูล</i>'}</div>
      <div class="small mt-10">เข้าร่วมเมื่อ: ${new Date(profile.createdAt).toLocaleDateString()}</div>
      <div class="small mt-8"><strong>อีเมล:</strong> ${profile.showEmail ? (profile.email || '<i>ไม่มี</i>') : '<i>ซ่อน</i>'}</div>`;
    document.getElementById('aboutArea').innerHTML = aboutHtml;

    document.getElementById('btnViewPublic').onclick = function() {
      window.location.href = '/user/' + encodeURIComponent(profile.username);
    };

    // Fetch and render posts
    const pr2 = await fetch('/api/user/' + encodeURIComponent(profile.username) + '/posts');
    if (pr2.ok) {
      const postsData = await pr2.json();
      const posts = postsData.posts || [];
      let postlist = '<div class="section-title"><span>โพสต์ของสมาชิกนี้</span></div>';
      if (posts.length === 0) {
        postlist += '<i class="small">ยังไม่มีโพสต์</i>';
      } else {
        postlist += posts.map(p => {
          const truncated = (p.content || '').length > 200 ? escapeHtml((p.content || '').slice(0,200)) + '...' : escapeHtml(p.content || '');
          return `<div class="post" style="padding:12px 14px; margin-bottom:10px;">
            <div style="flex:1">
              <h4 style="margin:0 0 6px 0;"><a href="/post/${encodeURIComponent(p.id)}">${escapeHtml(p.title)}</a></h4>
              <div class="small" style="color:var(--muted); margin-bottom:8px;">${new Date(p.createdAt).toLocaleString()}</div>
              <div>${truncated}</div>
            </div>
            ${p.image ? `<div style="margin-top:8px;"><a href="/post/${encodeURIComponent(p.id)}"><img src="${p.image}" alt="post image" style="max-width:160px;border-radius:8px;"></a></div>` : ''}
          </div>`;
        }).join('');
      }
      document.getElementById('userPosts').innerHTML = postlist;
    } else {
      document.getElementById('userPosts').innerHTML = '<i class="small">ไม่สามารถโหลดโพสต์ได้</i>';
    }
  } catch (err) {
    document.getElementById('aboutArea').innerHTML = '<div class="small">เกิดข้อผิดพลาดขณะโหลดข้อมูล</div>';
    document.getElementById('userPosts').innerHTML = '';
    console.error(err);
  }
}

function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

renderProfile();
</script>
</body>
</html>